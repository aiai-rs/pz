<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨æ‹ç…§æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; font-family: Arial; background:#000; color:#fff; }
  #container { position:relative; width:100vw; height:100vh; }
  video { width:100%; height:100%; object-fit:cover; }
  #overlay {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(0,0,0,0.6);
    padding: 10px 15px;
    border-radius: 8px;
    font-size: 16px;
    line-height: 1.4;
    pointer-events: none;
    max-width: 90%;
  }
  #controls {
    position: absolute;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%);
    text-align: center;
  }
  button {
    background:#fff;
    border:none;
    width:70px;
    height:70px;
    border-radius:50%;
    font-size:40px;
    cursor:pointer;
    box-shadow:0 4px 20px rgba(0,0,0,0.5);
  }
  #status { position:absolute; top:20px; left:0; right:0; text-align:center; color:#0f0; font-size:14px; }
</style>
</head>
<body>

<div id="container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div id="location">è·å–ä½ç½®ä¸­...</div>
  </div>

  <div id="controls">
    <button id="capture">ğŸ“¸</button>
  </div>

  <div id="status">æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´å’Œå®šä½...</div>
</div>

<script>
// ==================== é…ç½®åŒº ====================
// 1. æ”¹æˆä½ çš„ Render åç«¯åŸŸåï¼ˆä¾‹å¦‚ https://xxxx.onrender.com/uploadï¼‰
const BACKEND_URL = "https://huiying888.onrender.com/upload";

// 2. è‡ªåŠ¨è¯»å–ç¾¤IDï¼ˆä» /hc /boss /lg æŒ‰é’®å¸¦è¿‡æ¥çš„ ?chatid= å‚æ•°ï¼‰
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');
// ===============================================

let track = null;
window.currentLocation = null;

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  const str = now.toLocaleString('zh-CN', {hour12:false});
  document.getElementById('time').textContent = "ğŸ•– " + str;
}
setInterval(updateTime, 1000);
updateTime();

// é«˜ç²¾åº¦å®šä½
function startLocation() {
  if (!navigator.geolocation) {
    document.getElementById('location').textContent = "âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½";
    return;
  }
  const options = { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 };
  track = navigator.geolocation.watchPosition(pos => {
    const lat = pos.coords.latitude.toFixed(6);
    const lng = pos.coords.longitude.toFixed(6);
    const acc = pos.coords.accuracy.toFixed(0);
    document.getElementById('location').innerHTML = `ğŸ“ ${lat}, ${lng}<br>ç²¾åº¦ â‰ˆ ${acc}m`;
    window.currentLocation = {lat: parseFloat(lat), lng: parseFloat(lng), acc};
  }, err => {
    document.getElementById('location').textContent = "âŒ å®šä½å¤±è´¥ï¼š" + err.message;
  }, options);
}

// å¯åŠ¨åç½®æ‘„åƒå¤´
async function startCamera() {
  const video = document.getElementById('video');
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment", width: {ideal: 4096}, height: {ideal: 4096} },
      audio: false
    });
    video.srcObject = stream;
    document.getElementById('status').textContent = "âœ… å°±ç»ªï¼Œç‚¹å‡»ä¸‹æ–¹æ‹ç…§æŒ‰é’®";
  } catch(e) {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({video: true});
      video.srcObject = stream;
      document.getElementById('status').textContent = "âš ï¸ ä½¿ç”¨å‰ç½®æ‘„åƒå¤´";
    } catch(err) {
      document.getElementById('status').textContent = "âŒ æ— æ³•æ‰“å¼€æ‘„åƒå¤´";
    }
  }
}

// ç”Ÿæˆåœ°å›¾é“¾æ¥
function getMapLinks(lat, lng) {
  const amap = `https://amap.com/dir?destination=${lng},${lat}&name=æ‹ç…§ä½ç½®`;
  const google = `https://www.google.com/maps?q=${lat},${lng}`;
  return {amap, google};
}

// çƒ§æ°´å°
function drawWatermarkAndUpload(imageBlob) {
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const img = new Image();
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img, 0, 0);

    const now = new Date().toLocaleString('zh-CN', {hour12:false});
    const {lat, lng} = window.currentLocation || {lat:'?', lng:'?'};
    const text = `${now}\nç»çº¬åº¦ï¼š${lat}, ${lng}`;

    ctx.font = 'bold 40px Arial';
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 6;
    ctx.textBaseline = 'bottom';

    const lines = text.split('\n');
    let y = canvas.height - 40;
    lines.forEach(line => {
      ctx.strokeText(line, 40, y);
      ctx.fillText(line, 40, y);
      y -= 60;
    });

    canvas.toBlob(blob => {
      uploadToBackend(blob, lat, lng);
    }, 'image/jpeg', 0.95);
  };
  img.src = URL.createObjectURL(imageBlob);
}

// ä¸Šä¼ åˆ°ä½ çš„åç«¯
function uploadToBackend(blob, lat, lng) {
  const form = new FormData();
  form.append('photo', blob, `photo_${Date.now()}.jpg`);

  const url = new URL(BACKEND_URL);
  url.searchParams.set('lat', lat.toFixed(6));
  url.searchParams.set('lng', lng.toFixed(6));
  url.searchParams.set('name', 'æ±‡ç›ˆç”¨æˆ·');
  url.searchParams.set('uid', Date.now());
  url.searchParams.set('time', Date.now());
  if (TARGET_CHAT_ID) {
    url.searchParams.set('chatid', TARGET_CHAT_ID); // å…³é”®ï¼šåªå‘å½“å‰ç¾¤
  }

  document.getElementById('status').textContent = "â³ æ­£åœ¨ä¸Šä¼ å¹¶æ¨é€åˆ°ç¾¤...";

  fetch(url, {
    method: 'POST',
    body: form
  }).then(r => r.json()).then(res => {
    if (res.code === 0) {
      const {amap, google} = getMapLinks(lat, lng);
      const text = `ğŸ“¸ æ‹ç…§æ‰“å¡æˆåŠŸï¼\nğŸ•° æ—¶é—´ï¼š${new Date().toLocaleString('zh-CN')}\nğŸ“ ä½ç½®ï¼š${lat.toFixed(6)}, ${lng.toFixed(6)}\nğŸ—º é«˜å¾·åœ°å›¾ï¼š${amap}\nğŸ—º è°·æ­Œåœ°å›¾ï¼š${google}`;
      navigator.clipboard.writeText(text);
      document.getElementById('status').innerHTML = "âœ… ä¸Šä¼ æˆåŠŸï¼<br>ç…§ç‰‡å·²å‘é€åˆ°å½“å‰ç¾¤å’Œå¤‡ä»½ç¾¤<br>ä½ç½®æ–‡å­—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿";
    } else {
      document.getElementById('status').textContent = "âŒ ä¸Šä¼ å¤±è´¥ï¼š" + JSON.stringify(res);
    }
  }).catch(err => {
    document.getElementById('status').textContent = "âŒ ç½‘ç»œé”™è¯¯ï¼š" + err.message;
  });
}

// æ‹ç…§ä¸»é€»è¾‘
document.getElementById('capture').addEventListener('click', () => {
  if (!window.currentLocation) {
    alert("æ­£åœ¨è·å–ä½ç½®ï¼Œè¯·ç¨ç­‰å‡ ç§’å†æ‹...");
    return;
  }
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  canvas.toBlob(blob => {
    drawWatermarkAndUpload(blob);
  }, 'image/jpeg', 0.95);
});

// å¯åŠ¨
startCamera();
startLocation();

// å…³é—­é¡µé¢æ—¶åœæ­¢å®šä½ï¼ˆçœç”µï¼‰
window.addEventListener('beforeunload', () => {
  if (track) navigator.geolocation.clearWatch(track);
});
</script>

</body>
</html>
