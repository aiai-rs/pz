<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹ç…§ç¡®è®¤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 25%, #4a69bd 50%, #6a89cc 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            color: #fff;
            overflow-x: hidden;
            position: relative;
        }
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            z-index: -1;
        }
        .container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            border-radius: 28px;
            padding: 45px 35px;
            text-align: center;
            box-shadow:
                0 20px 60px rgba(0, 0, 0, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.15);
            max-width: 440px;
            width: 100%;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: fadeInUp 0.7s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        h1 {
            font-size: 36px;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #ffffff 0%, #e6e9ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            display: inline-block;
        }
        h1::after {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 25%;
            width: 50%;
            height: 3px;
            background: linear-gradient(90deg, transparent, #4facfe, transparent);
            border-radius: 3px;
        }
        p {
            font-size: 17px;
            opacity: 0.9;
            margin-bottom: 35px;
            line-height: 1.6;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.85);
        }
        .browser-warning {
            display: none;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            text-align: left;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        .browser-warning h3 {
            color: #ffcc00;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .browser-warning p {
            margin-bottom: 15px;
            font-size: 15px;
        }
        .browser-warning ul {
            margin-left: 20px;
            margin-bottom: 20px;
        }
        .browser-warning li {
            margin-bottom: 8px;
            font-size: 14px;
        }
        .open-browser-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 14px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            margin-top: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 8px 25px rgba(79, 172, 254, 0.4);
        }
        .open-browser-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(79, 172, 254, 0.5);
        }
        .camera-choice {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 6px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .camera-btn {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 14px 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            flex: 1;
            font-size: 16px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        .camera-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .camera-btn:hover::before {
            left: 100%;
        }
        .camera-btn:hover {
            color: white;
            transform: translateY(-2px);
        }
        .camera-btn.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: translateY(-2px);
        }
        .btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            border: none;
            color: white;
            padding: 18px 30px;
            font-size: 18px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow:
                0 8px 25px rgba(255, 107, 107, 0.4),
                0 2px 5px rgba(255, 107, 107, 0.2);
            width: 100%;
            margin-bottom: 25px;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .btn:hover::before {
            left: 100%;
        }
        .btn:hover {
            transform: translateY(-3px);
            box-shadow:
                0 12px 30px rgba(255, 107, 107, 0.5),
                0 4px 8px rgba(255, 107, 107, 0.3);
        }
        .btn:active {
            transform: translateY(-1px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }
        .send-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 16px 28px;
            font-size: 17px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow:
                0 8px 25px rgba(79, 172, 254, 0.4),
                0 2px 5px rgba(79, 172, 254, 0.2);
            width: 100%;
            margin-top: 15px;
            font-weight: 600;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            display: none;
        }
        .send-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        .send-btn:hover::before {
            left: 100%;
        }
        .send-btn:hover {
            transform: translateY(-3px);
            box-shadow:
                0 12px 30px rgba(79, 172, 254, 0.5),
                0 4px 8px rgba(79, 172, 254, 0.3);
        }
        .send-btn:active {
            transform: translateY(-1px);
        }
        .retry-btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 16px;
            display: none;
            width: 100%;
        }
        .retry-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        .status {
            font-size: 15px;
            opacity: 0.9;
            margin-top: 15px;
            min-height: 22px;
            transition: all 0.3s ease;
            font-weight: 500;
            padding: 12px 15px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        #videoPreview, #photoPreview {
            width: 100%;
            height: 220px;
            object-fit: cover;
            border-radius: 18px;
            margin-top: 25px;
            display: none;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: zoomIn 0.5s ease;
        }
        #captureBtn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            font-size: 16px;
            display: none;
        }
        #captureBtn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.4);
        }
        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        .loading {
            display: none;
            margin: 25px 0;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error {
            color: #ffcccc;
            background: rgba(255, 102, 102, 0.15);
            padding: 12px 15px;
            border-radius: 12px;
            margin: 12px 0;
            border: 1px solid rgba(255, 102, 102, 0.3);
            font-weight: 500;
        }
        .confirm-text {
            background: rgba(255, 255, 255, 0.12);
            padding: 18px;
            border-radius: 16px;
            margin: 25px 0;
            font-style: italic;
            border-left: 4px solid #4facfe;
            text-align: left;
            font-size: 16px;
            line-height: 1.5;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .confirm-text::before {
            content: '"';
            font-size: 60px;
            position: absolute;
            left: 10px;
            top: -10px;
            opacity: 0.3;
            color: #4facfe;
            font-family: serif;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 3px;
            position: relative;
            overflow: hidden;
        }
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background-image: linear-gradient(
                -45deg,
                rgba(255, 255, 255, 0.2) 25%,
                transparent 25%,
                transparent 50%,
                rgba(255, 255, 255, 0.2) 50%,
                rgba(255, 255, 255, 0.2) 75%,
                transparent 75%,
                transparent
            );
            background-size: 20px 20px;
            animation: moveStripes 1s linear infinite;
        }
        @keyframes moveStripes {
            0% { background-position: 0 0; }
            100% { background-position: 20px 0; }
        }
        .photo-counter {
            display: none;
            margin-top: 15px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 500;
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 107, 107, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 107, 107, 0); }
        }
        .floating {
            animation: floating 3s ease-in-out infinite;
        }
        @keyframes floating {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
    </style>
</head>
<body>
    <div class="container floating">
        <h1 id="title">ğŸ“¸ æ‹ç…§ç¡®è®¤</h1>
        <p id="description">è¯·é€‰æ‹©æ‘„åƒå¤´å¹¶ç¡®è®¤ç²¾å‡†ä½ç½®</p>
        
        <!-- æ–°å¢ï¼šæµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š -->
        <div id="browserWarning" class="browser-warning">
            <h3>âš ï¸ æµè§ˆå™¨å…¼å®¹æ€§æç¤º</h3>
            <p>æ£€æµ‹åˆ°æ‚¨æ­£åœ¨ä½¿ç”¨Telegramå†…ç½®æµè§ˆå™¨ï¼Œéƒ¨åˆ†åŠŸèƒ½å¯èƒ½å—é™ã€‚</p>
            <p><strong>æ¨èæ“ä½œï¼š</strong></p>
            <ul>
                <li>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åœ¨ç³»ç»Ÿæµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é¡µé¢</li>
                <li>æˆ–æ‰‹åŠ¨å¤åˆ¶é“¾æ¥åˆ°æ‰‹æœºè‡ªå¸¦æµè§ˆå™¨ä¸­æ‰“å¼€</li>
            </ul>
            <button id="openInBrowser" class="open-browser-btn">
                ğŸŒ åœ¨ç³»ç»Ÿæµè§ˆå™¨ä¸­æ‰“å¼€
            </button>
        </div>
        
        <div id="confirmText" class="confirm-text" style="display:none;"></div>
        <div class="camera-choice">
            <button class="camera-btn active" onclick="selectCamera('back')" id="backBtn">ğŸ“· åç½®æ‘„åƒå¤´</button>
            <button class="camera-btn" onclick="selectCamera('front')" id="frontBtn">ğŸ¤³ å‰ç½®æ‘„åƒå¤´</button>
        </div>
        <button id="signInBtn" class="btn pulse">å¼€å§‹æ‹ç…§ç¡®è®¤</button>
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>å¤„ç†ä¸­... <div class="progress-bar"><div class="progress-fill"></div></div></p>
        </div>
        <div id="photoCounter" class="photo-counter">ç…§ç‰‡ 1/2</div>
        <video id="videoPreview" autoplay playsinline muted></video>
        <img id="photoPreview" src="" alt="ç…§ç‰‡é¢„è§ˆ">
        <button id="captureBtn" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <button id="retryCameraBtn" class="retry-btn" onclick="retryCamera()">ğŸ”„ é‡è¯•ç›¸æœºè®¿é—®</button>
        <button id="sendBtn" class="send-btn" onclick="manualSend()">ğŸ“¤ å‘é€åˆ°ç¾¤ç»„ï¼ˆæ— ä½ç½®ï¼‰</button>
        <div id="status" class="status">ç­‰å¾…ä½ç½®ç¡®è®¤...</div>
    </div>
    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        console.log('Telegram WebApp åˆå§‹åŒ–å®Œæˆ');
        
        // æ£€æµ‹æ˜¯å¦åœ¨Telegramå†…ç½®æµè§ˆå™¨ä¸­
        function isTelegramBrowser() {
            return navigator.userAgent.includes('Telegram') || 
                   typeof window.TelegramWebviewProxy !== 'undefined';
        }
        
        // æ˜¾ç¤ºæµè§ˆå™¨å…¼å®¹æ€§è­¦å‘Š
        function showBrowserWarning() {
            const browserWarning = document.getElementById('browserWarning');
            browserWarning.style.display = 'block';
            
            // æ·»åŠ ä¸€é”®è·³è½¬åŠŸèƒ½
            document.getElementById('openInBrowser').addEventListener('click', function() {
                const currentUrl = window.location.href;
                // å°è¯•ä½¿ç”¨Telegramçš„openLinkæ–¹æ³•
                if (tg && tg.openLink) {
                    tg.openLink(currentUrl);
                } else {
                    // å¤‡ç”¨æ–¹æ¡ˆï¼šåœ¨æ–°çª—å£æ‰“å¼€
                    window.open(currentUrl, '_blank');
                }
            });
        }
        
        // åœ¨é¡µé¢åŠ è½½æ—¶æ£€æµ‹æµè§ˆå™¨ç¯å¢ƒ
        window.addEventListener('load', function() {
            if (isTelegramBrowser()) {
                console.log('æ£€æµ‹åˆ°Telegramå†…ç½®æµè§ˆå™¨ï¼Œæ˜¾ç¤ºè­¦å‘Š');
                showBrowserWarning();
            } else {
                console.log('æ£€æµ‹åˆ°ç³»ç»Ÿæµè§ˆå™¨ï¼ŒåŠŸèƒ½æ­£å¸¸');
            }
        });
        
        // ä» URL å‚æ•°è·å–ç±»å‹
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type') || 'default'; // boss æˆ– lg æˆ– hc
        // åŠ¨æ€è®¾ç½®æ ‡é¢˜å’Œæè¿°
        const titles = {
            boss: 'ğŸ“¸ Boss è¦æ±‚æ‹ç…§',
            lg: 'ğŸ“¸ é¾™å“¥è¦æ±‚æ‹ç…§',
            hc: 'ğŸš— æ¢è½¦å®‰å…¨ç¡®è®¤'
        };
        const descriptions = {
            boss: 'æ±‡ç›ˆå›½é™…è´Ÿè´£äºº@Bossè¦æ±‚ä½ æ‹ç…§ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æ‹ç…§',
            lg: 'æ±‡ç›ˆå›½é™…è´Ÿè´£äººé¾å“¥è¦æ±‚ä½ æ‹ç…§ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æ‹ç…§',
            hc: 'ä¸ºäº†ä¿éšœä½ å®‰å…¨æ¢è½¦å‰è¯·æ‹ç…§ï¼æ¢è½¦ä¸€å®šè¦æ˜¯ä¸Šä¸€ä¸ªå¸æœºå®‰æ’çš„å“¦ï¼Œå¦‚æœæ˜¯è¯·ç‚¹å‡»ä¸‹æ–¹æ‹ç…§ï¼Œå¦‚æœä¸æ˜¯è¯·è”ç³»è´Ÿè´£äºº'
        };
        const confirmTexts = {
            boss: 'âœ… ç¡®è®¤ï¼šå·²æŒ‰ Boss è¦æ±‚æ‹ç…§',
            lg: 'âœ… ç¡®è®¤ï¼šå·²æŒ‰é¾™å“¥è¦æ±‚æ‹ç…§',
            hc: 'âœ… ç¡®è®¤ï¼šæœ¬æ¬¡æ¢è½¦ç”±ä¸Šä¸€ä¸ªå¸æœºå®‰æ’'
        };
        document.getElementById('title').textContent = titles[type] || 'ğŸ“¸ æ‹ç…§ç¡®è®¤';
        document.getElementById('description').textContent = descriptions[type] || 'è¯·æ‹ç…§å¹¶ç¡®è®¤ä½ç½®';
        const confirmDiv = document.getElementById('confirmText');
        confirmDiv.textContent = confirmTexts[type] || '';
        confirmDiv.style.display = confirmTexts[type] ? 'block' : 'none';
        const signInBtn = document.getElementById('signInBtn');
        const loading = document.getElementById('loading');
        const videoPreview = document.getElementById('videoPreview');
        const photoPreview = document.getElementById('photoPreview');
        const captureBtn = document.getElementById('captureBtn');
        const retryCameraBtn = document.getElementById('retryCameraBtn');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        const photoCounter = document.getElementById('photoCounter');
        let currentLocation = null;
        let currentCamera = 'back'; // é»˜è®¤åç½®
        let photos = []; // å­˜å‚¨åŒç…§ç‰‡
        let stream = null; // ç›¸æœºæµ
        let videoTrack = null; // è§†é¢‘è½¨é“
        let locationRetries = 0; // é‡è¯•è®¡æ•°
        const maxLocationRetries = 5; // å¢åŠ åˆ°5æ¬¡ï¼Œæé«˜å¼¹å‡ºæ¬¡æ•°
        let cameraRetries = 0; // ç›¸æœºé‡è¯•è®¡æ•°
        const maxCameraRetries = 2; // ç›¸æœºæœ€å¤§é‡è¯•æ¬¡æ•°
        let locationFetching = false; // ä½ç½®è·å–æ ‡å¿—ï¼Œé˜²èµ›è·‘
        let locationFailed = false; // æ–°å¢ï¼šä½ç½®å¤±è´¥æ ‡å¿—ï¼Œæ§åˆ¶æ‰‹åŠ¨å‘é€æŒ‰é’®

        // æ‘„åƒå¤´é€‰æ‹©
        function selectCamera(cam) {
            console.log('åˆ‡æ¢æ‘„åƒå¤´:', cam); // è°ƒè¯•
            currentCamera = cam;
            document.querySelectorAll('.camera-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(cam === 'back' ? 'backBtn' : 'frontBtn').classList.add('active');
            retryCameraBtn.style.display = 'none'; // åˆ‡æ¢æ—¶éšè—é‡è¯•æŒ‰é’®
            sendBtn.style.display = 'none'; // éšè—å‘é€æŒ‰é’®
            stopCamera();
            startCamera(); // åˆ‡æ¢æ‘„åƒå¤´
        }

        // å¯åŠ¨ç›¸æœº (WebRTC getUserMedia)
        async function startCamera() {
            console.log('å¯åŠ¨ç›¸æœºä¸­...'); // è°ƒè¯•
            try {
                const constraints = {
                    video: {
                        facingMode: currentCamera === 'back' ? 'environment' : 'user',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoPreview.srcObject = stream;
                videoPreview.style.display = 'block';
                videoTrack = stream.getVideoTracks()[0];
                captureBtn.style.display = 'block';
                retryCameraBtn.style.display = 'none'; // éšè—é‡è¯•æŒ‰é’®
                sendBtn.style.display = 'none'; // éšè—å‘é€æŒ‰é’®
                status.textContent = 'ç›¸æœºå°±ç»ªï¼Œç‚¹å‡»æ‹ç…§ ğŸ“¸';
                console.log('ç›¸æœºå¯åŠ¨æˆåŠŸ'); // è°ƒè¯•
                cameraRetries = 0; // é‡ç½®é‡è¯•
            } catch (error) {
                console.error('ç›¸æœºå¯åŠ¨å¤±è´¥:', error); // è°ƒè¯•
                cameraRetries++;
                let errorMsg = 'ç›¸æœºè®¿é—®å¤±è´¥';
                if (error.name === 'NotAllowedError') {
                    errorMsg = 'ç›¸æœºæƒé™è¢«æ‹’ç»';
                    // å¦‚æœæ˜¯åœ¨Telegramå†…ç½®æµè§ˆå™¨ä¸­ï¼Œæ˜¾ç¤ºç‰¹æ®Šæç¤º
                    if (isTelegramBrowser()) {
                        errorMsg += ' - è¯·ä½¿ç”¨ç³»ç»Ÿæµè§ˆå™¨æ‰“å¼€æ­¤é¡µé¢';
                    }
                } else if (error.name === 'NotFoundError') {
                    errorMsg = 'æœªæ‰¾åˆ°å¯ç”¨æ‘„åƒå¤´';
                } else if (error.name === 'NotReadableError') {
                    errorMsg = 'æ‘„åƒå¤´è¢«å ç”¨ï¼Œè¯·å…³é—­å…¶ä»–åº”ç”¨';
                } else {
                    errorMsg += `: ${error.message}`;
                }
                status.innerHTML = `<span class="error">${errorMsg} â€“ è¯·åœ¨ç³»ç»Ÿè®¾ç½®ä¸­æˆæƒç›¸æœºæƒé™ ğŸ”’</span>`;
                retryCameraBtn.style.display = 'block';
                if (cameraRetries >= maxCameraRetries) {
                    // æœ€ç»ˆå¤±è´¥ï¼šå¼¹å‡º Telegram è­¦å‘Šï¼Œå¼•å¯¼ç”¨æˆ·
                    tg.showAlert('ç›¸æœºæƒé™æœªæˆæƒï¼è¯·å»ç³»ç»Ÿè®¾ç½® > éšç§ > ç›¸æœº > å…è®¸ Telegram è®¿é—®ï¼Œç„¶åé‡è¯•ã€‚å¦åˆ™æ— æ³•æ‹ç…§ã€‚');
                } else {
                    // é¦–æ¬¡æ‹’ç»ï¼šå¼¹å‡ºå‹å¥½è­¦å‘Š
                    tg.showAlert('é¦–æ¬¡è®¿é—®ç›¸æœºè¢«æ‹’ç»ï¼Ÿè¯·ç¡®è®¤æˆæƒï¼\n\næ­¥éª¤ï¼š\n1. ç‚¹å‡»"å…è®¸"æˆ–"å¥½çš„"\n2. å¦‚æœå·²æ‹’ç»ï¼Œå»è®¾ç½®é‡å¯æˆæƒ\n\né‡è¯•åå°†ç›´æ¥å¯åŠ¨ç›¸æœºã€‚');
                }
            }
        }

        // é‡è¯•ç›¸æœºå‡½æ•°
        function retryCamera() {
            console.log('é‡è¯•ç›¸æœº...'); // è°ƒè¯•
            status.textContent = 'é‡è¯•ç›¸æœºè®¿é—®ä¸­... â³';
            retryCameraBtn.style.display = 'none';
            setTimeout(() => startCamera(), 500); // çŸ­æš‚å»¶è¿Ÿé‡è¯•
        }

        // åœæ­¢ç›¸æœº
        function stopCamera() {
            console.log('åœæ­¢ç›¸æœº'); // è°ƒè¯•
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            videoPreview.style.display = 'none';
            captureBtn.style.display = 'none';
        }

        // æ‰‹åŠ¨å‘é€å‡½æ•°
        function manualSend() {
            console.log('æ‰‹åŠ¨å‘é€æ•°æ®...'); // è°ƒè¯•
            sendBtn.style.display = 'none';
            loading.style.display = 'block';
            const progressFill = document.querySelector('.progress-fill');
            let width = 0;
            const interval = setInterval(() => {
                width += 20;
                progressFill.style.width = width + '%';
                if (width >= 100) clearInterval(interval);
            }, 150);
            setTimeout(() => {
                sendData();
                loading.style.display = 'none';
                // å‘é€åå¼¹å‡ºæç¤º
                tg.showAlert('å›¾ç‰‡å‘é€æˆåŠŸï¼Œä½ç½®æœªå‘é€ï¼');
                // æ›´æ–°çŠ¶æ€æ–‡æœ¬
                status.textContent = 'å›¾ç‰‡å‘é€æˆåŠŸï¼Œä½ç½®æœªå‘é€ï¼ğŸ“¤';
            }, 1000);
        }

        // å¼‚æ­¥è·å–ä½ç½®å‡½æ•°ï¼ˆä½¿ç”¨åŸç”Ÿ geolocation ä½œä¸ºä¸»æ–¹å¼ï¼Œæé«˜æˆåŠŸç‡ï¼‰
        function getLocationWithRetry() {
            if (locationFetching) return; // é˜²é‡å¤è°ƒç”¨
            locationFetching = true;
            locationFailed = false; // é‡ç½®å¤±è´¥æ ‡å¿—
            sendBtn.style.display = 'none'; // éšè—å‘é€æŒ‰é’®
            console.log('å¼€å§‹ä½ç½®è·å–'); // è°ƒè¯•
            const options = {
                enableHighAccuracy: true, // å¯ç”¨é«˜ç²¾åº¦ GPSï¼Œæé«˜å‡†ç¡®ç‡
                timeout: 15000, // 15ç§’è¶…æ—¶ï¼Œå¹³è¡¡é€Ÿåº¦å’ŒæˆåŠŸç‡
                maximumAge: 60000 // æœ€å¤šä½¿ç”¨1åˆ†é’Ÿå‰çš„ç¼“å­˜ä½ç½®ï¼Œæé«˜å“åº”é€Ÿåº¦
            };

            const tryGeolocation = (retryCount = 0) => {
                console.log(`ä½ç½®é‡è¯•: ${retryCount + 1}/${maxLocationRetries}`); // è°ƒè¯•
                status.textContent = `è·å–ä½ç½®ä¸­... (å°è¯• ${retryCount + 1}/${maxLocationRetries}) â³ å»ºè®®å®¤å¤–å¼€å¯GPSï¼ˆå®¤å†…ä¿¡å·å¼±å¯èƒ½ç¨æ…¢ï¼‰`;
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        console.log('ä½ç½®è·å–æˆåŠŸ:', position.coords); // è°ƒè¯•
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                            accuracy: position.coords.accuracy || 0
                        };
                        let accText;
                        if (currentLocation.accuracy > 100) {
                            accText = `ä½ç½®è·å–æˆåŠŸï¼Œä½†ç²¾åº¦è¾ƒä½ (${currentLocation.accuracy.toFixed(0)}m)ï¼Œå»ºè®®å®¤å¤–é‡è¯• ğŸ“`;
                        } else if (currentLocation.accuracy > 50) {
                            accText = `ä½ç½®è·å–æˆåŠŸ (ç²¾åº¦: ${currentLocation.accuracy.toFixed(0)}m) ğŸ“`;
                        } else {
                            accText = `ä½ç½®ç²¾å‡†è·å–æˆåŠŸ (ç²¾åº¦: ${currentLocation.accuracy.toFixed(0)}m) âœ…`;
                        }
                        status.textContent = accText;
                        locationRetries = 0; // é‡ç½®é‡è¯•
                        locationFetching = false; // ç»“æŸ fetching
                        // ä½ç½®æˆåŠŸï¼šè‡ªåŠ¨å‘é€
                        if (photos.length === 2) {
                            sendData();
                        }
                    },
                    (error) => {
                        console.error('ä½ç½®è·å–é”™è¯¯:', error); // è°ƒè¯•
                        if (retryCount < maxLocationRetries - 1) {
                            // é‡è¯•ï¼šçŸ­æš‚å»¶è¿Ÿåé‡è¯•ï¼Œæé«˜æˆåŠŸç‡
                            setTimeout(() => tryGeolocation(retryCount + 1), 2000);
                        } else {
                            // æœ€ç»ˆå¤±è´¥ï¼šæ˜¾ç¤ºæ‰‹åŠ¨å‘é€æŒ‰é’®
                            console.log('ä½ç½®æœ€ç»ˆå¤±è´¥ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨å‘é€æŒ‰é’®'); // è°ƒè¯•
                            status.innerHTML = `<span class="error">ä½ç½®è·å–å¤±è´¥ (é”™è¯¯: ${error.message})ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‰‹åŠ¨å‘é€å›¾ç‰‡ âŒ</span>`;
                            currentLocation = null; // æˆ–ä½¿ç”¨ {lat:0, lng:0, accuracy:999}
                            locationRetries = 0;
                            locationFetching = false; // ç»“æŸ fetching
                            locationFailed = true; // è®¾ç½®å¤±è´¥æ ‡å¿—
                            sendBtn.style.display = 'block'; // æ˜¾ç¤ºå‘é€æŒ‰é’®
                        }
                    },
                    options
                );
            };

            tryGeolocation(0);
        }

        // æˆªå›¾æ‹ç…§
        function capturePhoto() {
            console.log('æ‹ç…§ä¸­...'); // è°ƒè¯•
            const canvas = document.createElement('canvas');
            canvas.width = videoPreview.videoWidth;
            canvas.height = videoPreview.videoHeight;
            canvas.getContext('2d').drawImage(videoPreview, 0, 0);
            const photoData = canvas.toDataURL('image/jpeg', 0.8); // JPEG å‹ç¼©
            photos.push(photoData);
            photoCounter.textContent = `ç…§ç‰‡ ${photos.length}/2`;
            photoCounter.style.display = 'block';
            photoPreview.src = photoData;
            photoPreview.style.display = 'block';
            if (photos.length === 1) {
                status.textContent = 'åç½®æ‹ç…§å®Œæˆï¼åˆ‡æ¢å‰ç½®è‡ªæ‹ç¡®è®¤ ğŸ¤³';
                selectCamera('front');
            } else if (photos.length === 2) {
                console.log('åŒæ‹ç…§å®Œæˆï¼Œå¼€å§‹è¡¥ä½ç½®'); // è°ƒè¯•
                status.textContent = 'åŒæ‹ç…§å®Œæˆï¼è·å–ä½ç½®ä¸­... ğŸ“¤';
                // æ‹ç…§åå¼‚æ­¥è·å–ä½ç½®ï¼ˆåè¡¥ï¼‰ï¼Œä¸é˜»å¡
                getLocationWithRetry();
                loading.style.display = 'block';
                const progressFill = document.querySelector('.progress-fill');
                let width = 0;
                const interval = setInterval(() => {
                    width += 10;
                    progressFill.style.width = width + '%';
                    if (width >= 100) clearInterval(interval);
                }, 200);
                // å»¶è¿Ÿæ£€æŸ¥ï¼šå¦‚æœä½ç½®æˆåŠŸå·²è‡ªåŠ¨å‘é€ï¼›å¤±è´¥åˆ™æŒ‰é’®å·²æ˜¾ç¤º
                setTimeout(() => {
                    if (photos.length < 2) return; // å®‰å…¨æ ¡éªŒ
                    loading.style.display = 'none'; // éšè—åŠ è½½
                    if (locationFetching) {
                        // ä»åœ¨è·å–ï¼Œå»¶é•¿ç­‰å¾…
                        status.textContent = 'ä½ç½®è·å–ä¸­ï¼Œè¯·ç¨ç­‰... â³';
                        setTimeout(arguments.callee, 2000); // é€’å½’ç­‰å¾… 2s
                        return;
                    }
                    // å¦‚æœä½ç½®å¤±è´¥ï¼ŒæŒ‰é’®å·²æ˜¾ç¤ºï¼›å¦åˆ™å·²å‘é€
                }, 3000); // ç»™é‡è¯•æ›´å¤šæ—¶é—´
            }
        }

        // å‘é€æ•°æ®å‡½æ•°
        function sendData() {
            if (photos.length < 2) return; // å®‰å…¨æ ¡éªŒ
            console.log('å‘é€æ•°æ®ä¸­...'); // è°ƒè¯•
            // ç”Ÿæˆé“¾æ¥ (å¦‚æœæœ‰ä½ç½®)
            let googleLink = '';
            let gaodeLink = '';
            if (currentLocation && currentLocation.lat && currentLocation.lng) {
                googleLink = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}&z=18&ll=${currentLocation.lat},${currentLocation.lng}`;
                gaodeLink = `https://uri.amap.com/marker?position=${currentLocation.lng},${currentLocation.lat}&callnative=1&zoom=18`;
            }
            const data = {
                type: type,
                userId: tg.initDataUnsafe.user.id,
                userName: tg.initDataUnsafe.user.first_name || 'åŒ¿å',
                photo: photos[0] + '|' + photos[1], // åˆå¹¶åŒç…§ç‰‡ base64
                location: currentLocation || null,
                googleMap: googleLink,
                gaodeMap: gaodeLink,
                timestamp: new Date().toISOString(),
                confirm: confirmTexts[type] || 'æ‹ç…§å®Œæˆ'
            };
            tg.sendData(JSON.stringify(data));
            status.textContent = 'åŒæ‹ç…§æˆåŠŸï¼å·²æ¨é€è‡³ç¾¤ç»„ ğŸ‰';
            loading.style.display = 'none';
            sendBtn.style.display = 'none';
            signInBtn.disabled = true;
            signInBtn.textContent = 'å·²å®Œæˆ';
            signInBtn.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            signInBtn.classList.remove('pulse');
            stopCamera();
            console.log('æ•°æ®å‘é€å®Œæˆ'); // è°ƒè¯•
        }

        // æŒ‰é’®ç‚¹å‡»ï¼šç›´æ¥å¯åŠ¨ç›¸æœºï¼Œä¸ä¾èµ–ä½ç½®
        signInBtn.addEventListener('click', function() {
            console.log('æŒ‰é’®ç‚¹å‡»ï¼Œå¯åŠ¨æµç¨‹'); // è°ƒè¯•
            status.textContent = 'å¯åŠ¨ç›¸æœºä¸­... ğŸ“¸';
            startCamera(); // å…ˆå¯åŠ¨ç›¸æœº
            // åŒæ—¶å¼‚æ­¥å¼€å§‹ä½ç½®è·å–ï¼Œæé«˜æ•´ä½“æˆåŠŸç‡
            getLocationWithRetry();
            signInBtn.disabled = true;
            signInBtn.textContent = 'ç›¸æœºå¯åŠ¨ä¸­...';
        });

        // é¡µé¢å…³é—­æ¸…ç†ç›¸æœº
        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
