<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹ç…§ç¡®è®¤æµ‹è¯•ç‰ˆ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ä½ åŸæ¥çš„ç¾åŒ–æ ·å¼æˆ‘å…¨ä¿ç•™äº†ï¼Œåªåˆ æ‰æ— å…³éƒ¨åˆ†ï¼Œä¿æŒå¥½çœ‹ */
        *{margin:0;padding:0;box-sizing:border-box;}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;background:linear-gradient(135deg,#0c2461,#1e3799,#4a69bd,#6a89cc);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
        .container{background:rgba(255,255,255,0.08);backdrop-filter:blur(25px);border-radius:28px;padding:40px 30px;max-width:420px;width:100%;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.25);border:1px solid rgba(255,255,255,0.1);}
        h1{font-size:36px;margin-bottom:12px;background:linear-gradient(135deg,#fff,#e6e9ff);-webkit-background-clip:text;background-clip:text;color:transparent;font-weight:700;}
        p{font-size:17px;opacity:0.9;margin-bottom:30px;line-height:1.6;}
        .btn{background:linear-gradient(135deg,#ff6b6b,#ff8e8e);border:none;color:white;padding:18px;border-radius:50px;font-size:18px;width:100%;margin:15px 0;cursor:pointer;box-shadow:0 8px 25px rgba(255,107,107,0.4);}
        .btn:hover{transform:translateY(-3px);box-shadow:0 15px 35px rgba(255,107,107,0.5);}
        .send-btn{background:linear-gradient(135deg,#4facfe,#00f2fe);display:none;}
        #video{width:100%;height:240px;object-fit:cover;border-radius:18px;margin:20px 0;display:none;box-shadow:0 10px 30px rgba(0,0,0,0.3);}
        #preview{width:100%;border-radius:18px;margin:20px 0;display:none;}
        .status{margin-top:15px;padding:12px;background:rgba(255,255,255,0.1);border-radius:12px;font-size:15px;}
        .error{color:#ffcccc;background:rgba(255,0,0,0.2);}
        .loading{text-align:center;margin:20px 0;display:none;}
        .spinner{border:4px solid rgba(255,255,255,0.2);border-top:4px solid #fff;border-radius:50%;width:40px;height:40px;margin:0 auto 10px;animation:spin 1s linear infinite;}
        @keyframes spin{to{transform:rotate(360deg);}}
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¸ æ‹ç…§ç¡®è®¤ï¼ˆæµ‹è¯•ç‰ˆï¼‰</h1>
    <p id="desc">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ‹ç…§ + è‡ªåŠ¨æˆªå±ç¡®è®¤èº«ä»½</p>
    
    <button id="startBtn" class="btn">ğŸš€ å¼€å§‹æ‹ç…§ç¡®è®¤</button>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>å¤„ç†ä¸­ï¼Œè¯·ç¨ç­‰...</p>
    </div>
    
    <video id="video" playsinline muted></video>
    <img id="preview" />
    
    <button id="sendManual" class="btn send-btn">ğŸ“¤ ä½ç½®å¤±è´¥ï¼Ÿç‚¹æˆ‘åªå‘ç…§ç‰‡</button>
    
    <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const urlParams = new URLSearchParams(location.search);
    const type = urlParams.get('type') || 'test';
    const titles = {boss:'Bossè¦æ±‚æ‹ç…§', lg:'é¾™å“¥è¦æ±‚æ‹ç…§', hc:'æ¢è½¦å®‰å…¨ç¡®è®¤', test:'æµ‹è¯•æ‹ç…§åŠŸèƒ½'};
    document.querySelector('h1').textContent = 'ğŸ“¸ ' + (titles[type] || 'æ‹ç…§ç¡®è®¤');
    document.getElementById('desc').textContent = type==='hc' ? 'æ¢è½¦å‰è¯·æ‹ç…§ç¡®è®¤å®‰å…¨' : 'è¯·æŒ‰è¦æ±‚å®Œæˆæ‹ç…§';

    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('startBtn');
    const sendManual = document.getElementById('sendManual');
    const status = document.getElementById('status');
    const loading = document.getElementById('loading');

    let stream = null;
    let realPhotoBlob = null;
    let screenshotBlob = null;
    let location = null;

    // ç¬¬ä¸€æ­¥ï¼šè¯·æ±‚ç›¸æœºï¼ˆåªç”¨åç½®ï¼‰
    async function startCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment", width: {ideal: 1280}, height: {ideal: 720} }
            });
            video.srcObject = stream;
            video.style.display = 'block';
            status.textContent = 'ç›¸æœºå·²å¼€å¯ â†’ ç‚¹å‡»æŒ‰é’®æ‹ç…§';
            startBtn.textContent = 'ğŸ“¸ ç«‹å³æ‹ç…§';
            startBtn.onclick = capture;
        } catch (e) {
            status.innerHTML = `<span class="error">ç›¸æœºæƒé™è¢«æ‹’ï¼è¯·å»è®¾ç½®æ‰“å¼€ Telegram ç›¸æœºæƒé™</span>`;
            tg.showAlert('éœ€è¦ç›¸æœºæƒé™æ‰èƒ½æ‹ç…§ï¼\nè¯·å»æ‰‹æœºè®¾ç½® â†’ éšç§ â†’ ç›¸æœº â†’ å…è®¸ Telegram');
        }
    }

    // ç¬¬äºŒæ­¥ï¼šæ‹ç…§ + æˆªå±
    async function capture() {
        loading.style.display = 'block';
        startBtn.disabled = true;

        // 1. çœŸå®ç…§ç‰‡
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        realPhotoBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.65));

        // 2. æˆªå½“å‰é¡µé¢ï¼ˆå¸¦æ ‡é¢˜ã€æ—¶é—´ã€ç”¨æˆ·åï¼Œé˜²ä½œå¼Šï¼‰
        const html2canvasScript = document.createElement('script');
        html2canvasScript.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
        document.head.appendChild(html2canvasScript);
        html2canvasScript.onload = async () => {
            const canvas2 = await html2canvas(document.body, {scale: 1.5, useCORS: true});
            screenshotBlob = await new Promise(r => canvas2.toBlob(r, 'image/jpeg', 0.6));

            preview.src = URL.createObjectURL(realPhotoBlob);
            preview.style.display = 'block';
            loading.style.display = 'none';
            status.textContent = 'ç…§ç‰‡å‡†å¤‡å®Œæˆï¼Œæ­£åœ¨è·å–ä½ç½®...';

            stopCamera();
            getLocationAndSend();
        };
    }

    function stopCamera() {
        if (stream) stream.getTracks().forEach(t => t.stop());
        video.style.display = 'none';
    }

    // ç¬¬ä¸‰æ­¥ï¼šå°è¯•è·å–ä½ç½®ï¼ˆåŒä¿é™©ï¼‰
    function getLocationAndSend() {
        let tried = false;

        // æ–¹æ¡ˆ1ï¼šTelegram åŸç”Ÿï¼ˆæˆåŠŸç‡æœ€é«˜ï¼‰
        tg.requestLocation(pos => {
            if (pos) {
                location = {lat: pos.latitude, lng: pos.longitude};
                sendAll();
            } else if (!tried) {
                tried = true;
                fallbackGeolocation();
            }
        });

        // æ–¹æ¡ˆ2ï¼šæ™®é€š geolocation å…œåº•
        function fallbackGeolocation() {
            if (!navigator.geolocation) return sendAll();
            navigator.geolocation.getCurrentPosition(
                pos => {
                    location = {lat: pos.coords.latitude, lng: pos.coords.longitude};
                    sendAll();
                },
                () => sendAll(), // å¤±è´¥ä¹Ÿç›´æ¥å‘
                {enableHighAccuracy: true, timeout: 10000}
            );
        }

        // 10ç§’åæ— è®ºå¦‚ä½•éƒ½å‘ï¼ˆé˜²æ­¢å¡æ­»ï¼‰
        setTimeout(() => {
            if (!realPhotoBlob) return;
            sendManual.style.display = 'block';
            status.textContent = 'ä½ç½®è¶…æ—¶ï¼Œå¯ç›´æ¥å‘ç…§ç‰‡';
        }, 10000);
    }

    // æœ€ç»ˆå‘é€ï¼ˆä¸€å®šèƒ½å‘å‡ºå»ï¼‰
    function sendAll() {
        const data = {
            type: type,
            userId: tg.initDataUnsafe.user?.id || 0,
            userName: tg.initDataUnsafe.user?.first_name || 'åŒ¿å',
            location: location,
            timestamp: new Date().toISOString()
        };

        // ç”¨ sendPhoto åˆ†åˆ«å‘ä¸¤å¼ å›¾ï¼ˆæœ€ç¨³ï¼ï¼‰
        tg.sendPhoto({photo: realPhotoBlob}, {caption: JSON.stringify(data)});
        setTimeout(() => {
            tg.sendPhoto({photo: screenshotBlob}, {caption: "ã€é¡µé¢æˆªå›¾ç¡®è®¤ã€‘"});
        }, 800);

        status.textContent = 'âœ… å‘é€æˆåŠŸï¼å·²æ¨é€è‡³ç¾¤ç»„';
        startBtn.textContent = 'å·²å®Œæˆ';
        startBtn.disabled = true;
        sendManual.style.display = 'none';
        tg.close();
    }

    // æ‰‹åŠ¨å‘ï¼ˆä¸å¸¦ä½ç½®ï¼‰
    sendManual.onclick = () => {
        location = null;
        sendAll();
    };

    // å¼€å§‹æŒ‰é’®
    startBtn.onclick = () => {
        tg.showAlert('å³å°†å¼€å¯ç›¸æœºæ‹ç…§ï¼Œè¯·å¯¹å‡†è‡ªå·±æˆ–è½¦è¾†\næ‹ç…§åä¼šè‡ªåŠ¨æˆªå±ä½œä¸ºç¬¬äºŒå¼ ç¡®è®¤å›¾', startCamera);
    };
</script>
</body>
</html>
