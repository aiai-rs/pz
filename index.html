<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨æ‹ç…§æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin:0; font-family: Arial,Helvetica,sans-serif; background:#000; color:#fff; overflow:hidden; }
  #container { position:relative; width:100vw; height:100vh; }
  video { width:100%; height:100%; object-fit:cover; }
  #overlay { position:absolute; Shockwave Flash 0 0; bottom:20px; left:20px; background:rgba(0,0,0,0.6); padding:12px 18px; border-radius:10px; font-size:18px; line-height:1.5; pointer-events:none; max-width:90%; }
  #controls { position:absolute; bottom:100px; left:50%; transform:translateX(-50%); z-index:10; }
  button#capture {
    background:#fff; border:none; width:80px; height:80px; border-radius:50%; font-size:48px; cursor:pointer;
    box-shadow:0 6px 30px rgba(0,0,0,0.6); outline:none; position:relative; overflow:hidden;
  }
  button#capture:disabled { opacity:0.5; cursor:not-allowed; }

  /* Loading è½¬åœˆåŠ¨ç”» */
  #loadingOverlay {
    position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.75);
    display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100;
    opacity:0; pointer-events:none; transition:opacity 0.3s;
  }
  #loadingOverlay.show { opacity:1; pointer-events:all; }
  .spinner {
    width:60px; height:60px; border:6px solid #333; border-top:6px solid #0f0; border-radius:50%;
    animation:spin 1s linear infinite; margin-bottom:20px;
  }
  @keyframes spin { to { transform:rotate(360deg); } }

  #status { position:absolute; top:20px; left:0; right:0; text-align:center; color:#0f0; font-size:16px; padding:0 20px; z-index:10; }
</style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div id="location">ç‚¹å‡»æ‹ç…§æŒ‰é’®è·å–ä½ç½® â†’</div>
  </div>

  <div id="controls">
    <button id="capture">ğŸ“¸</button>
  </div>

  <div id="status">ç‚¹å‡»æ‹ç…§æŒ‰é’®å¼€å§‹æ‰“å¡</div>

  <!-- Loading åŠ¨ç”»å±‚ -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-size:18px;">æ­£åœ¨ä¸Šä¼ ç…§ç‰‡ï¼Œè¯·ç¨å€™...</div>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const BACKEND_URL = "https://huiying888.onrender.com/upload"; // ä½ çš„åç«¯
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');
// ===============================================

let stream = null;
let locationGranted = false;
let isUploading = false;

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = "ğŸ• " + now.toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// Telegram WebApp è‡ªåŠ¨å…³é—­ï¼ˆæˆåŠŸåï¼‰
function closeWebApp() {
  if (window.Telegram?.WebApp?.close) {
    window.Telegram.WebApp.close();
  }
}

// æ˜¾ç¤º/éšè— loading
function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('show', show);
}

// å…³é”®ï¼šTelegram iOS å¿…é¡»åœ¨ç”¨æˆ·çœŸå®ç‚¹å‡»åæ‰èƒ½æ‹¿åˆ°åç½®æ‘„åƒå¤´ + é«˜ç²¾åº¦å®šä½
async function requestPermissionsAndStartCamera() {
  if (locationGranted) return true;

  document.getElementById('status').textContent = "ğŸ”µ æ­£åœ¨è¯·æ±‚æƒé™ï¼Œè¯·åœ¨å¼¹çª—ä¸­å…è®¸ã€Œå®šä½ã€å’Œã€Œæ‘„åƒå¤´ã€";

  // 1. é«˜ç²¾åº¦å®šä½
  await new Promise((resolve) => {
    const watchId = navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      const acc = Math.round(pos.coords.accuracy);
      document.getElementById('location').innerHTML = `ğŸ“ ${lat}, ${lng}<br>ç²¾åº¦ â‰ˆ ${acc}m`;
      if (acc > 80) {
        document.getElementById('location').innerHTML += '<br><span style="color:#ff0">âš ï¸ ç²¾åº¦è¾ƒå·®ï¼Œå»ºè®®é è¿‘çª—å£æˆ–å¼€å¯é«˜ç²¾åº¦æ¨¡å¼</span>';
      }
      window.currentLocation = {lat, lng, acc};
      locationGranted = true;
      navigator.geolocation.clearWatch(watchId);
      resolve();
    }, () => {
      document.getElementById('status').textContent = "âŒ å®šä½æƒé™è¢«æ‹’ç»ï¼Œæ— æ³•æ‰“å¡";
      resolve();
    }, {enableHighAccuracy: true, maximumAge: 0, timeout: 15000});
  });

  // 2. é‡æ–°å¼€å¯åç½®æ‘„åƒå¤´ï¼ˆTelegram iOS å¿…é¡»åœ¨ç”¨æˆ·äº¤äº’åæ‰èƒ½å¼€åç½®ï¼‰
  if (stream) stream.getTracks().forEach(t => t.stop());
  stream = await navigator.mediaDevices.getUserMedia({
    video: {
      facingMode: { ideal: "environment" },  // å¼ºåˆ¶åç½®
      width: { ideal: 4096 },
      height: { ideal: 4096 }
    },
    audio: false
  });
  document.getElementById('video').srcObject = stream;

  document.getElementById('status').textContent = "âœ… å°±ç»ªï¼Œç›´æ¥ç‚¹å‡»æ‹ç…§æŒ‰é’®æ‰“å¡";
  return true;
}

// åˆå§‹é™é»˜å¼€å¯æ‘„åƒå¤´ï¼ˆåªä¸ºå ä½ï¼Œé¿å…ç¬¬ä¸€æ¬¡ç‚¹æŒ‰é’®å¡é¡¿ï¼‰
navigator.mediaDevices.getUserMedia({video: true}).then(s => {
  stream = s;
  document.getElementById('video').srcObject = s;
}).catch(() => {});

// æ‹ç…§ä¸»é€»è¾‘
document.getElementById('capture').addEventListener('click', async () => {
  if (isUploading) return;
  
  // ç¬¬ä¸€æ¬¡ç‚¹å‡»å¿…é¡»èµ°æƒé™æµç¨‹
  if (!locationGranted) {
    const ok = await requestPermissionsAndStartCamera();
    if (!ok || !window.currentLocation) {
      alert("å¿…é¡»åŒæ—¶å…è®¸ã€Œç²¾ç¡®å®šä½ã€å’Œã€Œæ‘„åƒå¤´ã€æƒé™æ‰èƒ½æ‰“å¡ï¼");
      return;
    }
  }

  if (!window.currentLocation) {
    alert("å®šä½è¿˜åœ¨è·å–ï¼Œè¯·ç¨ç­‰å‡ ç§’å†è¯•");
    return;
  }

  // é˜²æ­¢é‡å¤ç‚¹å‡»
  isUploading = true;
  const btn = document.getElementById('capture');
  btn.disabled = true;
  showLoading(true);
  document.getElementById('status').textContent = "æ­£åœ¨å¤„ç†ç…§ç‰‡...";

  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth || 1920;
  canvas.height = video.videoHeight || 1080;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  // å¤šä½ç½®åŠé€æ˜æ°´å°ï¼ˆé˜²è£å‰ªã€På›¾ï¼‰
  const now = new Date().toLocaleString('zh-CN', {hour12:false});
  const text = `${now}\nç»çº¬åº¦ï¼š${window.currentLocation.lat},${window.currentLocation.lng}\nç²¾åº¦â‰ˆ${window.currentLocation.acc}m`;
  ctx.font = 'bold 44px Arial';
  ctx.strokeStyle = 'rgba(0,0,0,0.8)';
  ctx.lineWidth = 8;
  ctx.fillStyle = 'rgba(255,255,255,0.85)';
  ctx.textBaseline = 'bottom';

  // å·¦ä¸‹ã€å³ä¸‹ã€é¡¶éƒ¨ä¸­é—´ ä¸‰å¤„æ°´å°
  [40, canvas.width/2, canvas.width-40].forEach((x, i) => {
    let y = i === 2 ? 80 : canvas.height - 40;
    ctx.textAlign = i === 0 ? 'left' : i === 1 ? 'center' : 'right';
    ctx.strokeText(text, x, y);
    ctx.fillText(text, x, y);
  });

  canvas.toBlob(async blob => {
    const form = new FormData();
    form.append('photo', blob, 'daka.jpg');

    const url = new URL(BACKEND_URL);
    url.searchParams.set('lat', window.currentLocation.lat);
    url.searchParams.set('lng', window.currentLocation.lng);
    url.searchParams.set('name', 'æ±‡ç›ˆç”¨æˆ·');
    url.searchParams.set('time', Date.now());
    if (TARGET_CHAT_ID) url.searchParams.set('chatid', TARGET_CHAT_ID);

    try {
      const r = await fetch(url, {method: 'POST', body: form});
      const res = await r.json();
      if (res.code === 0) {
        document.getElementById('status').innerHTML = "âœ… æ‰“å¡æˆåŠŸï¼<br>3ç§’åè‡ªåŠ¨å…³é—­";
        setTimeout(closeWebApp, 3000);
      } else {
        document.getElementById('status').textContent = "âŒ ä¸Šä¼ å¤±è´¥ï¼š" + (res.msg || 'æœªçŸ¥é”™è¯¯');
      }
    } catch (e) {
      document.getElementById('status').textContent = "âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•";
    } finally {
      showLoading(false);
      btn.disabled = false;
      isUploading = false;
    }
  }, 'image/jpeg', 0.95);
});
</script>
</body>
</html>
