<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®‰å…¨éªŒè¯ç»ˆç«¯</title>
    <style>
        /* ==================== 0. å…¨å±€è®¾ç½® ==================== */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; overflow: hidden; 
            font-family: "SF Pro Display", -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            color: #fff;
        }

        /* ==================== 1. å…¨å±ç›¸æœºå®¹å™¨ ==================== */
        #camera-container { 
            position: relative; width: 100%; height: 100%; 
            z-index: 1;
        }
        
        /* è§†é¢‘ä¸ç”»å¸ƒé‡å ï¼Œç”¨äºå®šæ ¼ç”»é¢ */
        video, canvas { 
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%; object-fit: cover; 
        }
        #canvas { display: none; z-index: 2; } /* æ‹ç…§åæ˜¾ç¤ºè¿™ä¸ª */

        /* ==================== 2. é«˜çº§ HUD ç•Œé¢ (é€æ˜æ‚¬æµ®) ==================== */
        
        /* å››è§’è£…é¥° (ç§‘æŠ€æ„Ÿ) */
        .corner {
            position: absolute; width: 40px; height: 40px;
            border-color: rgba(255, 255, 255, 0.4); border-style: solid;
            z-index: 10; pointer-events: none;
        }
        .tl { top: 20px; left: 20px; border-width: 2px 0 0 2px; }
        .tr { top: 20px; right: 20px; border-width: 2px 2px 0 0; }
        .bl { bottom: 20px; left: 20px; border-width: 0 0 2px 2px; }
        .br { bottom: 20px; right: 20px; border-width: 0 2px 2px 0; }

        /* é¡¶éƒ¨ä¿¡æ¯ */
        .header-info {
            position: absolute; top: 50px; left: 0; width: 100%;
            text-align: center; z-index: 10;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        .status-badge {
            display: inline-flex; align-items: center; gap: 6px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 6px 16px; border-radius: 30px;
            backdrop-filter: blur(10px);
            font-size: 13px; letter-spacing: 1px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px #00ff88; }

        /* ==================== 3. åº•éƒ¨æ§åˆ¶åŒº (å…¨é€æ˜) ==================== */
        .controls-area {
            position: absolute; bottom: 0; left: 0; width: 100%;
            height: 180px; z-index: 20;
            background: linear-gradient(to top, rgba(0,0,0,0.7) 0%, transparent 100%);
            display: flex; justify-content: center; align-items: center;
        }

        /* æ‹ç…§æŒ‰é’® (æç®€åœ†ç¯) */
        .shutter-btn {
            width: 80px; height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.8);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(4px);
            position: relative; cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }
        .shutter-btn::after {
            content: ''; position: absolute;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 66px; height: 66px;
            background: #fff; border-radius: 50%;
            transition: all 0.2s;
        }
        .shutter-btn:active { transform: scale(0.95); }
        .shutter-btn:active::after { width: 60px; height: 60px; opacity: 0.8; }

        /* ==================== 4. çŠ¶æ€/é”™è¯¯å¤„ç†å±‚ (è¦†ç›–åœ¨ç…§ç‰‡ä¸Š) ==================== */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            z-index: 50;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
        }
        
        /* é”™è¯¯æç¤ºå¡ç‰‡ */
        .msg-box {
            text-align: center; padding: 20px;
        }
        .msg-title { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .msg-sub { font-size: 14px; color: #ccc; margin-bottom: 30px; }

        /* æŒ‰é’®ç»„ */
        .action-btn {
            padding: 12px 30px; border-radius: 30px;
            font-size: 15px; font-weight: 500; cursor: pointer;
            border: none; margin: 10px;
            transition: all 0.2s; min-width: 160px;
            display: block;
        }
        
        /* è“è‰²æŒ‰é’®ï¼šé‡è¯•å®šä½ */
        .btn-retry {
            background: linear-gradient(135deg, #007aff, #0056b3);
            color: white; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
        }
        
        /* çº¢è‰²æŒ‰é’®ï¼šå¼ºåˆ¶å‘é€ */
        .btn-force {
            background: linear-gradient(135deg, #ff3b30, #d70015);
            color: white; box-shadow: 0 4px 15px rgba(255, 59, 48, 0.4);
            animation: pulse 2s infinite;
        }
        
        /* ç°è‰²æŒ‰é’®ï¼šå–æ¶ˆ/é‡æ‹ */
        .btn-cancel {
            background: rgba(255,255,255,0.1); color: #fff;
            border: 1px solid rgba(255,255,255,0.2);
        }

        /* é“¾æ¥å¤±æ•ˆçš„å…¨å±è­¦å‘Š */
        #invalid-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 100;
            display: none; flex-direction: column;
            justify-content: center; align-items: center; text-align: center;
        }
        .icon-error { font-size: 60px; margin-bottom: 20px; }

        /* åŠ è½½åŠ¨ç”» */
        .loader {
            width: 48px; height: 48px; border: 3px solid #FFF;
            border-bottom-color: transparent; border-radius: 50%;
            display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

    </style>
</head>
<body>

<!-- ç›¸æœºå–æ™¯å™¨ -->
<div id="camera-container">
    <!-- è£…é¥°å…ƒç´  -->
    <div class="corner tl"></div><div class="corner tr"></div>
    <div class="corner bl"></div><div class="corner br"></div>

    <!-- é¡¶éƒ¨çŠ¶æ€ -->
    <div class="header-info">
        <div class="status-badge">
            <div class="dot" id="status-dot"></div>
            <span id="user-display">ç³»ç»Ÿå°±ç»ª</span>
        </div>
    </div>

    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>

    <!-- åº•éƒ¨æ‹ç…§æŒ‰é’® -->
    <div class="controls-area" id="controls">
        <div class="shutter-btn" id="shutter"></div>
    </div>
</div>

<!-- ç»“æœ/åŠ è½½/é”™è¯¯ è¦†ç›–å±‚ -->
<div id="result-overlay">
    <div class="msg-box">
        <div class="loader" id="spinner"></div>
        <div class="msg-title" id="overlay-title">æ­£åœ¨ä¸Šä¼ </div>
        <div class="msg-sub" id="overlay-desc">æ­£åœ¨åŠ å¯†ä¼ è¾“æ•°æ®...</div>
        
        <!-- æ“ä½œæŒ‰é’®åŒºåŸŸ (åˆå§‹éšè—) -->
        <div id="action-area" style="display:none;">
            <!-- åªé‡æ–°è·å–ä½ç½®ï¼Œä¸é‡æ‹ -->
            <button class="action-btn btn-retry" id="btn-retry-loc">ğŸ“¡ é‡æ–°è·å–ä½ç½®</button>
            
            <!-- å¼ºåˆ¶å‘é€ (3æ¬¡å¤±è´¥åå‡ºç°) -->
            <button class="action-btn btn-force" id="btn-force" style="display:none;">âš ï¸ å¼ºåˆ¶å‘é€ (æ— å®šä½)</button>
            
            <!-- é‡æ‹æŒ‰é’® -->
            <button class="action-btn btn-cancel" id="btn-cancel">ğŸ”„ é‡æ‹ç…§ç‰‡</button>
        </div>
    </div>
</div>

<!-- é“¾æ¥å¤±æ•ˆä¸“ç”¨å±‚ -->
<div id="invalid-screen">
    <div class="icon-error">â›”ï¸</div>
    <h2>é“¾æ¥å·²å¤±æ•ˆ</h2>
    <p style="color:#888; padding: 0 20px; margin-top: 10px;">å®‰å…¨ä»¤ç‰Œå·²è¿‡æœŸæˆ–è¢«é‡ç½®ã€‚<br>è¯·åœ¨ç¾¤å†…ä½¿ç”¨æŒ‡ä»¤é‡æ–°è·å–æœ€æ–°é“¾æ¥ã€‚</p>
</div>

<script>
    // =================================================================
    // âš ï¸âš ï¸âš ï¸ å¿…é¡»ä¿®æ”¹ï¼šé…ç½®åç«¯åœ°å€ (ä¸å¸¦æ–œæ ) âš ï¸âš ï¸âš ï¸
    const BACKEND_URL = "https://ä½ çš„renderæœåŠ¡å.onrender.com"; 
    // =================================================================

    // DOM å…ƒç´ 
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const shutter = document.getElementById('shutter');
    const controls = document.getElementById('controls');
    const overlay = document.getElementById('result-overlay');
    const spinner = document.getElementById('spinner');
    const title = document.getElementById('overlay-title');
    const desc = document.getElementById('overlay-desc');
    const actionArea = document.getElementById('action-area');
    const btnRetry = document.getElementById('btn-retry-loc');
    const btnForce = document.getElementById('btn-force');
    const btnCancel = document.getElementById('btn-cancel');
    const invalidScreen = document.getElementById('invalid-screen');
    const userDisplay = document.getElementById('user-display');

    // URL å‚æ•°
    const params = new URLSearchParams(window.location.search);
    const chatId = params.get('chatid');
    const uid = params.get('uid') || '0';
    const token = params.get('token') || '';
    const name = decodeURIComponent(params.get('name') || 'æœªçŸ¥ç”¨æˆ·');

    if (name) userDisplay.innerText = `éªŒè¯ä¸­: ${name}`;

    let failCount = 0; // å®šä½å¤±è´¥è®¡æ•°å™¨

    // 1. å¯åŠ¨ç›¸æœº (é«˜æ¸…)
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: 'environment', width: { ideal: 1920 }, height: { ideal: 1080 } },
                audio: false
            });
            video.srcObject = stream;
        } catch (err) {
            alert("ç›¸æœºå¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™");
        }
    }

    // 2. æ‹ç…§é€»è¾‘ (ç‚¹å‡»å¿«é—¨)
    shutter.addEventListener('click', () => {
        if (!chatId) return showInvalidScreen();
        
        // A. å®šæ ¼ç”»é¢
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);
        
        // åˆ‡æ¢æ˜¾ç¤ºï¼šéšè—è§†é¢‘ï¼Œæ˜¾ç¤ºç”»å¸ƒ (é€ æˆâ€œå®šæ ¼â€æ•ˆæœ)
        video.style.display = 'none';
        canvas.style.display = 'block';
        controls.style.display = 'none'; // éšè—æ‹ç…§æŒ‰é’®

        // B. å¼€å§‹æµç¨‹ (é‡ç½®è®¡æ•°å™¨)
        // failCount = 0; // å¦‚æœä½ æƒ³æ¯æ¬¡é‡æ–°æ‹ç…§éƒ½é‡ç½®è®¡æ•°å™¨ï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œ
        startUploadProcess(true);
    });

    // 3. ä¸Šä¼ æµç¨‹æ§åˆ¶
    function startUploadProcess(retryLocation) {
        // æ˜¾ç¤ºé®ç½©
        overlay.style.display = 'flex';
        actionArea.style.display = 'none';
        spinner.style.display = 'inline-block';
        
        if (retryLocation) {
            title.innerText = "æ­£åœ¨è·å–å«æ˜Ÿå®šä½...";
            desc.innerText = "ä¸ºäº†æ‚¨çš„å®‰å…¨ï¼Œè¯·ç¡®ä¿GPSå·²å¼€å¯";
            getLocationAndUpload();
        } else {
            // å¼ºåˆ¶ä¸Šä¼ æ¨¡å¼
            title.innerText = "å¼ºåˆ¶ä¸Šä¼ ä¸­...";
            desc.innerText = "æ­£åœ¨ä½¿ç”¨å¤‡ç”¨é€šé“...";
            executeUpload(0, 0);
        }
    }

    // 4. è·å–å®šä½ (é«˜ç²¾åº¦æ¨¡å¼)
    function getLocationAndUpload() {
        if (!navigator.geolocation) return handleLocError("è®¾å¤‡ä¸æ”¯æŒå®šä½");

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                // æˆåŠŸ
                title.innerText = "å®šä½æˆåŠŸ";
                executeUpload(pos.coords.latitude, pos.coords.longitude);
            },
            (err) => {
                handleLocError(err);
            },
            { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
        );
    }

    // 5. å¤„ç†å®šä½é”™è¯¯
    function handleLocError(err) {
        console.warn("Loc Error:", err);
        failCount++;
        
        // æ˜¾ç¤ºé”™è¯¯çŠ¶æ€
        spinner.style.display = 'none';
        title.innerText = "âš ï¸ å®šä½å¤±è´¥";
        desc.innerText = `è¯·å°è¯•ç§»åŠ¨ä½ç½®æˆ–ç‚¹å‡»é‡è¯• (${failCount})`;
        
        // æ˜¾ç¤ºæŒ‰é’®
        actionArea.style.display = 'block';
        
        // å¤±è´¥3æ¬¡ä»¥ä¸Šæ˜¾ç¤ºå¼ºåˆ¶æŒ‰é’®
        if (failCount >= 3) {
            btnForce.style.display = 'block';
        } else {
            btnForce.style.display = 'none';
        }
    }

    // 6. æ‰§è¡Œä¸Šä¼ 
    function executeUpload(lat, lng) {
        canvas.toBlob(async (blob) => {
            try {
                const params = new URLSearchParams({
                    chatid: chatId, uid: uid, name: name, 
                    lat: lat, lng: lng, time: Date.now(), token: token
                });

                const response = await fetch(`${BACKEND_URL}/upload?${params.toString()}`, {
                    method: 'POST',
                    body: blob,
                    headers: { 'Content-Type': 'application/octet-stream' }
                });

                if (response.status === 403) {
                    showInvalidScreen();
                    return;
                }

                if (!response.ok) throw new Error("æœåŠ¡å™¨å“åº”é”™è¯¯");
                const result = await response.json();

                if (result.code === 0) {
                    title.innerText = "âœ… éªŒè¯é€šè¿‡";
                    desc.innerText = "æ•°æ®å·²å®‰å…¨ä¼ è¾“ï¼Œè¯·å…³é—­é¡µé¢";
                    spinner.style.display = 'none';
                    setTimeout(() => {
                        window.close();
                    }, 2000);
                } else {
                    throw new Error(result.msg);
                }
            } catch (err) {
                spinner.style.display = 'none';
                title.innerText = "âŒ ä¸Šä¼ å¤±è´¥";
                desc.innerText = err.message;
                actionArea.style.display = 'block';
                // ä¸Šä¼ å¤±è´¥ä¹Ÿå…è®¸é‡è¯•
            }
        }, 'image/jpeg', 0.8);
    }

    // 7. æŒ‰é’®äº‹ä»¶ç»‘å®š
    
    // [é‡æ–°è·å–ä½ç½®] -> ä»…ä»…é‡è·‘å®šä½é€»è¾‘ï¼Œä¸é‡æ‹
    btnRetry.addEventListener('click', () => {
        startUploadProcess(true);
    });

    // [å¼ºåˆ¶å‘é€] -> è·³è¿‡å®šä½ä¸Šä¼ 
    btnForce.addEventListener('click', () => {
        startUploadProcess(false);
    });

    // [é‡æ‹] -> å¤ä½ç•Œé¢ï¼Œå›åˆ°è§†é¢‘æµ
    btnCancel.addEventListener('click', () => {
        overlay.style.display = 'none';
        canvas.style.display = 'none';
        video.style.display = 'block';
        controls.style.display = 'flex';
    });

    function showInvalidScreen() {
        overlay.style.display = 'none';
        invalidScreen.style.display = 'flex';
    }

    // å¯åŠ¨
    startCamera();
</script>
</body>
</html>
