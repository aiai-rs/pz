<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨æ‹ç…§æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin:0; font-family: Arial, sans-serif; background:#000; color:#fff; }
  #container { position:relative; width:100vw; height:100vh; }
  video { width:100%; height:100%; object-fit:cover; }
  #overlay { position:absolute; top:20px; left:20px; background:rgba(0,0,0,0.7); padding:15px; border-radius:12px; }
  #controls { position:absolute; bottom:30px; left:50%; transform:translateX(-50%); }
  button#capture { background:#fff; border:none; width:70px; height:70px; border-radius:50%; font-size:28px; cursor:pointer; }
  button#capture:disabled { opacity:0.5; cursor:not-allowed; }
  #loadingOverlay { position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:100; opacity:0; transition:opacity 0.3s; }
  #loadingOverlay.show { opacity:1; }
  .spinner { width:50px; height:50px; border:4px solid #333; border-top:4px solid #4CAF50; border-radius:50%; animation:spin 1s linear infinite; margin-bottom:20px; }
  @keyframes spin { to { transform:rotate(360deg); } }
  #status { position:absolute; top:50%; left:0; right:0; text-align:center; color:#4CAF50; padding:15px; transform: translateY(-50%); background: rgba(0,0,0,0.7); margin:20px; border-radius:10px; }
  .error-message { position:absolute; bottom:180px; left:20px; right:20px; background:rgba(244,67,54,0.9); color:#fff; padding:12px; border-radius:10px; text-align:center; display:none; }
</style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div id="location">å‡†å¤‡è·å–ä½ç½®ä¿¡æ¯...</div>
  </div>

  <div id="status">å‡†å¤‡å¯åŠ¨æ‘„åƒå¤´...</div>

  <div id="controls">
    <button id="capture">ğŸ“¸</button>
  </div>

  <div id="errorMessage" class="error-message"></div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>æ­£åœ¨ä¸Šä¼ ç…§ç‰‡<br><small>è¯·å‹¿å…³é—­é¡µé¢</small></div>
  </div>
</div>

<script>
// é…ç½®
const BACKEND_URL = "https://huiying888.onrender.com/upload";
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');

let stream = null;
let locationData = null;
let isUploading = false;

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
  const errorEl = document.getElementById('errorMessage');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  setTimeout(() => errorEl.style.display = 'none', 5000);
}

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = "ğŸ• " + now.toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// æ˜¾ç¤º/éšè— loading
function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('show', show);
}

// åˆå§‹åŒ–æ‘„åƒå¤´
async function initCamera() {
  try {
    if (stream) stream.getTracks().forEach(track => track.stop());
    
    document.getElementById('status').textContent = "å¯åŠ¨åç½®æ‘„åƒå¤´ä¸­...";
    
    let constraints = {
      video: { facingMode: { exact: "environment" } },
      audio: false
    };
    
    try {
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch (exactError) {
      constraints = { video: { facingMode: "environment" }, audio: false };
      stream = await navigator.mediaDevices.getUserMedia(constraints);
    }
    
    document.getElementById('video').srcObject = stream;
    document.getElementById('status').textContent = "âœ… æ‘„åƒå¤´å°±ç»ªï¼Œç‚¹å‡»æ‹ç…§å¼€å§‹æ‰“å¡";
    return true;
  } catch (error) {
    document.getElementById('status').textContent = "âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™";
    showError("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·å…è®¸æ‘„åƒå¤´æƒé™");
    return false;
  }
}

// è·å–ä½ç½®ä¿¡æ¯
function getLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      resolve(null);
      return;
    }
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude.toFixed(6);
        const lng = position.coords.longitude.toFixed(6);
        const acc = Math.round(position.coords.accuracy);
        
        document.getElementById('location').innerHTML = `ğŸ“ ${lat}, ${lng}<br>ç²¾åº¦: ${acc}ç±³`;
        resolve({ lat, lng, acc });
      },
      (err) => {
        document.getElementById('location').textContent = "âŒ å®šä½è·å–å¤±è´¥";
        resolve(null);
      },
      { enableHighAccuracy: true, timeout: 10000 }
    );
  });
}

// ä¸Šä¼ ç…§ç‰‡ - ä½¿ç”¨æœ€ç®€å•çš„æ–¹æ³•
async function uploadPhoto(canvas, location) {
  return new Promise((resolve, reject) => {
    // å°†canvasè½¬æ¢ä¸ºBlob
    canvas.toBlob(async (blob) => {
      try {
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('photo', blob, 'photo.jpg');
        
        // åˆ›å»ºURLå‚æ•°
        const params = new URLSearchParams();
        if (location) {
          params.set('lat', location.lat);
          params.set('lng', location.lng);
          params.set('acc', location.acc);
        }
        params.set('name', 'æ±‡ç›ˆç”¨æˆ·');
        params.set('time', Date.now().toString());
        if (TARGET_CHAT_ID) {
          params.set('chatid', TARGET_CHAT_ID);
        }
        
        const url = `${BACKEND_URL}?${params.toString()}`;
        console.log('ä¸Šä¼ URL:', url);
        
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        resolve(result);
      } catch (error) {
        reject(error);
      }
    }, 'image/jpeg', 0.9);
  });
}

// æ‹ç…§ä¸»é€»è¾‘
document.getElementById('capture').addEventListener('click', async () => {
  if (isUploading) return;
  
  isUploading = true;
  const btn = document.getElementById('capture');
  btn.disabled = true;
  showLoading(true);
  
  try {
    // è·å–ä½ç½®
    document.getElementById('status').textContent = "è·å–ä½ç½®ä¿¡æ¯ä¸­...";
    locationData = await getLocation();
    
    // æ‹æ‘„ç…§ç‰‡
    document.getElementById('status').textContent = "æ‹æ‘„ç…§ç‰‡ä¸­...";
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // æ·»åŠ æ°´å°
    const now = new Date().toLocaleString('zh-CN', {hour12:false});
    const locationText = locationData 
      ? `ç»çº¬åº¦ï¼š${locationData.lat},${locationData.lng} ç²¾åº¦:${locationData.acc}m`
      : 'ä½ç½®ä¿¡æ¯è·å–å¤±è´¥';
    
    const text = `${now}\n${locationText}`;
    
    ctx.font = 'bold 32px Arial';
    ctx.strokeStyle = 'rgba(0,0,0,0.8)';
    ctx.lineWidth = 6;
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.textBaseline = 'bottom';
    ctx.textAlign = 'left';

    const x = 30;
    const y = canvas.height - 30;
    ctx.strokeText(text, x, y);
    ctx.fillText(text, x, y);

    // ä¸Šä¼ ç…§ç‰‡
    document.getElementById('status').textContent = "ä¸Šä¼ ç…§ç‰‡ä¸­...";
    
    const result = await uploadPhoto(canvas, locationData);
    
    if (result && result.code === 0) {
      document.getElementById('status').innerHTML = "âœ… æ‰“å¡æˆåŠŸï¼<br>3ç§’åè‡ªåŠ¨å…³é—­";
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.close) {
        setTimeout(() => Telegram.WebApp.close(), 3000);
      }
    } else {
      throw new Error(result?.msg || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
    }
    
  } catch (error) {
    console.error('æ‰“å¡å¤±è´¥:', error);
    document.getElementById('status').textContent = "âŒ æ‰“å¡å¤±è´¥";
    
    let errorMsg = error.message;
    if (error.message.includes('HTTP 400')) {
      errorMsg = "è¯·æ±‚æ ¼å¼é”™è¯¯ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒ";
    } else if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
      errorMsg = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ";
    }
    
    showError(errorMsg);
    
    btn.disabled = false;
    isUploading = false;
    showLoading(false);
  }
});

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', async () => {
  await initCamera();
  getLocation().then(location => {
    locationData = location;
  });
});
</script>
</body>
</html>
