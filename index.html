<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - æ‹ç…§æµ‹è¯•</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { 
    margin:0; 
    font-family: Arial, sans-serif; 
    background:#000; 
    color:#fff; 
    overflow:hidden; 
  }
  #container { 
    position:relative; 
    width:100vw; 
    height:100vh; 
    background: #000;
  }
  video { 
    width:100%; 
    height:100%; 
    object-fit:cover; 
  }
  #overlay { 
    position:absolute; 
    top:20px; 
    left:20px; 
    background:rgba(0,0,0,0.7); 
    padding:15px; 
    border-radius:12px; 
    font-size:16px;
  }
  #controls { 
    position:absolute; 
    bottom:30px; 
    left:50%; 
    transform:translateX(-50%); 
  }
  button#capture { 
    background:#fff; 
    border:none; 
    width:70px; 
    height:70px; 
    border-radius:50%; 
    font-size:28px; 
    cursor:pointer; 
  }
  button#capture:disabled { 
    opacity:0.5; 
    cursor:not-allowed; 
  }
  #loadingOverlay { 
    position:absolute; 
    top:0; 
    left:0; 
    width:100%; 
    height:100%; 
    background:rgba(0,0,0,0.85);
    display:flex; 
    flex-direction:column; 
    align-items:center; 
    justify-content:center; 
    z-index:100;
    opacity:0; 
    transition:opacity 0.3s; 
  }
  #loadingOverlay.show { 
    opacity:1; 
  }
  .spinner { 
    width:50px; 
    height:50px; 
    border:4px solid #333; 
    border-top:4px solid #4CAF50; 
    border-radius:50%;
    animation:spin 1s linear infinite; 
    margin-bottom:20px; 
  }
  @keyframes spin { 
    to { transform:rotate(360deg); } 
  }
  #status { 
    position:absolute; 
    top:50%; 
    left:0; 
    right:0; 
    text-align:center; 
    color:#4CAF50; 
    padding:15px; 
    transform: translateY(-50%); 
    background: rgba(0,0,0,0.7); 
    margin:20px; 
    border-radius:10px; 
  }
  .error-message { 
    position:absolute; 
    bottom:180px; 
    left:20px; 
    right:20px; 
    background:rgba(244,67,54,0.9); 
    color:#fff; 
    padding:12px; 
    border-radius:10px; 
    text-align:center; 
    display:none; 
  }
</style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>

  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div>ğŸ“ æµ‹è¯•æ¨¡å¼ - æ— å®šä½</div>
  </div>

  <div id="status">å‡†å¤‡å¯åŠ¨æ‘„åƒå¤´...</div>

  <div id="controls">
    <button id="capture">ğŸ“¸</button>
  </div>

  <div id="errorMessage" class="error-message"></div>

  <div id="loadingOverlay">
    <div class="spinner"></div>
    <div>æ­£åœ¨ä¸Šä¼ ç…§ç‰‡<br><small>è¯·å‹¿å…³é—­é¡µé¢</small></div>
  </div>
</div>

<script>
// é…ç½®
const BACKEND_URL = "https://huiying888.onrender.com/upload";
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');

let stream = null;
let isUploading = false;

// æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
function showError(message) {
  const errorEl = document.getElementById('errorMessage');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  setTimeout(() => errorEl.style.display = 'none', 5000);
}

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = "ğŸ• " + now.toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// æ˜¾ç¤º/éšè— loading
function showLoading(show) {
  document.getElementById('loadingOverlay').classList.toggle('show', show);
}

// åˆå§‹åŒ–æ‘„åƒå¤´ - ç®€åŒ–ç‰ˆæœ¬
async function initCamera() {
  try {
    // åœæ­¢ä¹‹å‰çš„æµ
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
    }
    
    document.getElementById('status').textContent = "å¯åŠ¨æ‘„åƒå¤´ä¸­...";
    
    // ç®€åŒ–çº¦æŸæ¡ä»¶
    const constraints = {
      video: {
        facingMode: "environment", // ä¼˜å…ˆåç½®
        width: { ideal: 1280 },
        height: { ideal: 720 }
      },
      audio: false
    };
    
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    document.getElementById('video').srcObject = stream;
    
    document.getElementById('status').textContent = "âœ… æ‘„åƒå¤´å°±ç»ªï¼Œç‚¹å‡»æ‹ç…§æµ‹è¯•";
    return true;
    
  } catch (error) {
    console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
    document.getElementById('status').textContent = "âŒ æ‘„åƒå¤´å¯åŠ¨å¤±è´¥";
    
    // å°è¯•ä½¿ç”¨å‰ç½®æ‘„åƒå¤´ä½œä¸ºå¤‡é€‰
    try {
      const fallbackConstraints = {
        video: {
          facingMode: "user",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        },
        audio: false
      };
      
      stream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
      document.getElementById('video').srcObject = stream;
      document.getElementById('status').textContent = "âœ… ä½¿ç”¨å‰ç½®æ‘„åƒå¤´ï¼Œç‚¹å‡»æ‹ç…§æµ‹è¯•";
      return true;
    } catch (fallbackError) {
      showError("æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®");
      return false;
    }
  }
}

// ä¸Šä¼ ç…§ç‰‡ - ç®€åŒ–ç‰ˆæœ¬
async function uploadPhoto(canvas) {
  return new Promise((resolve, reject) => {
    // å°†canvasè½¬æ¢ä¸ºBlob
    canvas.toBlob(async (blob) => {
      try {
        console.log('åˆ›å»ºFormDataï¼Œå›¾ç‰‡å¤§å°:', blob.size);
        
        // åˆ›å»ºFormData
        const formData = new FormData();
        formData.append('photo', blob, 'test_photo.jpg');
        
        // åˆ›å»ºURLå‚æ•° - ç®€åŒ–ç‰ˆæœ¬ï¼Œä¸åŒ…å«ä½ç½®ä¿¡æ¯
        const params = new URLSearchParams();
        params.set('name', 'æµ‹è¯•ç”¨æˆ·');
        params.set('time', Date.now().toString());
        if (TARGET_CHAT_ID) {
          params.set('chatid', TARGET_CHAT_ID);
        }
        
        const url = `${BACKEND_URL}?${params.toString()}`;
        console.log('ä¸Šä¼ URL:', url);
        
        const response = await fetch(url, {
          method: 'POST',
          body: formData
        });
        
        console.log('å“åº”çŠ¶æ€:', response.status, response.statusText);
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const result = await response.json();
        console.log('æœåŠ¡å™¨å“åº”:', result);
        resolve(result);
        
      } catch (error) {
        console.error('ä¸Šä¼ è¿‡ç¨‹ä¸­é”™è¯¯:', error);
        reject(error);
      }
    }, 'image/jpeg', 0.8); // é™ä½è´¨é‡ä»¥å‡å°æ–‡ä»¶å¤§å°
  });
}

// æ‹ç…§ä¸»é€»è¾‘
document.getElementById('capture').addEventListener('click', async () => {
  if (isUploading) {
    console.log('æ­£åœ¨ä¸Šä¼ ä¸­ï¼Œè·³è¿‡ç‚¹å‡»');
    return;
  }
  
  console.log('å¼€å§‹æ‹ç…§æµç¨‹');
  isUploading = true;
  const btn = document.getElementById('capture');
  btn.disabled = true;
  showLoading(true);
  
  try {
    // ç¬¬ä¸€æ­¥ï¼šæ‹æ‘„ç…§ç‰‡
    document.getElementById('status').textContent = "æ‹æ‘„ç…§ç‰‡ä¸­...";
    
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    
    // è®¾ç½®canvaså°ºå¯¸
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    // æ·»åŠ ç®€å•æ°´å°
    const now = new Date().toLocaleString('zh-CN', {hour12:false});
    const text = `æµ‹è¯•æ‹ç…§ - ${now}\næ— å®šä½ä¿¡æ¯`;
    
    ctx.font = 'bold 24px Arial';
    ctx.fillStyle = 'rgba(255,255,255,0.9)';
    ctx.textBaseline = 'bottom';
    ctx.textAlign = 'left';

    const x = 20;
    const y = canvas.height - 20;
    ctx.fillText(text, x, y);

    console.log('ç…§ç‰‡æ‹æ‘„å®Œæˆï¼Œå°ºå¯¸:', canvas.width, 'x', canvas.height);

    // ç¬¬äºŒæ­¥ï¼šä¸Šä¼ ç…§ç‰‡
    document.getElementById('status').textContent = "ä¸Šä¼ ç…§ç‰‡ä¸­...";
    
    const result = await uploadPhoto(canvas);
    
    if (result && result.code === 0) {
      document.getElementById('status').innerHTML = "âœ… æµ‹è¯•æˆåŠŸï¼<br>ä¸Šä¼ å®Œæˆ";
      console.log('ä¸Šä¼ æˆåŠŸ');
    } else {
      throw new Error(result?.msg || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
    }
    
  } catch (error) {
    console.error('æ‹ç…§å¤±è´¥:', error);
    document.getElementById('status').textContent = "âŒ æ‹ç…§å¤±è´¥";
    
    let errorMsg = error.message;
    if (error.message.includes('HTTP 400')) {
      errorMsg = "è¯·æ±‚æ ¼å¼é”™è¯¯ (HTTP 400)";
    } else if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
      errorMsg = "ç½‘ç»œè¿æ¥å¤±è´¥";
    }
    
    showError("ä¸Šä¼ å¤±è´¥: " + errorMsg);
    
  } finally {
    // é‡æ–°å¯ç”¨æŒ‰é’®
    btn.disabled = false;
    isUploading = false;
    showLoading(false);
  }
});

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('load', async () => {
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ‘„åƒå¤´');
  await initCamera();
});

// å¤„ç†æ‘„åƒå¤´é”™è¯¯
window.addEventListener('error', (event) => {
  console.error('å…¨å±€é”™è¯¯:', event.error);
});
</script>
</body>
</html>
