<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ‹ç…§ç¡®è®¤ - ç¨³å®šç‰ˆ</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,system-ui,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
    .box{background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:25px;padding:40px 30px;max-width:400px;width:100%;text-align:center;box-shadow:0 15px 35px rgba(0,0,0,0.3);}
    h1{font-size:34px;margin-bottom:10px;}
    p{font-size:17px;opacity:0.9;margin-bottom:30px;}
    button{background:linear-gradient(135deg,#f093fb,#f5576c);border:none;color:#fff;padding:18px;font-size:18px;border-radius:50px;width:100%;cursor:pointer;box-shadow:0 10px 30px rgba(245,87,108,0.4);}
    button:hover{transform:translateY(-4px);}
    button:disabled{opacity:0.6;transform:none;}
    #video,#preview{width:100%;max-height:300px;object-fit:cover;border-radius:15px;margin:20px 0;display:none;}
    .status{margin-top:15px;padding:12px;background:rgba(255,255,255,0.15);border-radius:12px;font-size:15px;}
    .manual{background:linear-gradient(135deg,#4facfe,#00f2fe);margin-top:15px;display:none;}
</style>
</head>
<body>
<div class="box">
    <h1>ğŸ“¸ æ‹ç…§ç¡®è®¤</h1>
    <p id="tip">ç‚¹å‡»æŒ‰é’®åä¼šå¼€å¯åç½®æ‘„åƒå¤´æ‹ç…§<br>åŒæ—¶è‡ªåŠ¨æˆªå±ä½œä¸ºç¬¬äºŒå¼ ç¡®è®¤å›¾</p>
    <button id="start">ğŸš€ ç«‹å³å¼€å§‹æ‹ç…§</button>
    <video id="video" playsinline muted></video>
    <img id="preview"/>
    <button id="manual" class="manual">ğŸ“¤ ä½ç½®å¤±è´¥ï¼Ÿç›´æ¥å‘ç…§ç‰‡</button>
    <div id="status" class="status">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const startBtn = document.getElementById('start');
    const manualBtn = document.getElementById('manual');
    const status = document.getElementById('status');

    let stream = null;
    let photoBlob = null;
    let screenBlob = null;
    let hasLocation = false;

    // ç›´æ¥å†…ç½®ä¸€ä¸ªæå°çš„æˆªå±å‡½æ•°ï¼ˆä¸å†ä¾èµ–å¤–éƒ¨ html2canvasï¼Œå½»åº•è§£å†³â€œæ²¡ååº”â€é—®é¢˜ï¼‰
    function captureScreen() {
        return new Promise(resolve => {
            // ç”¨ Telegram è‡ªå·±çš„æˆªå±åŠŸèƒ½ï¼ˆæœ€ç¨³ï¼ï¼‰
            if (tg.takeScreenshot) {
                tg.takeScreenshot(blob => {
                    resolve(blob || null);
                });
            } else {
                // å…œåº•ï¼šç”»ä¸€ä¸ªå¸¦æ–‡å­—çš„çº¯è‰²å›¾ä¹Ÿè¡Œ
                const canvas = document.createElement('canvas');
                canvas.width = 600; canvas.height = 800;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = '#667eea';
                ctx.fillRect(0,0,600,800);
                ctx.fillStyle = '#fff';
                ctx.font = '40px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ç”¨æˆ·ï¼š'+ (tg.initDataUnsafe.user?.first_name || 'åŒ¿å'), 300, 300);
                ctx.fillText('æ—¶é—´ï¼š'+ new Date().toLocaleString(), 300, 400);
                canvas.toBlob(resolve, 'image/jpeg', 0.7);
            }
        });
    }

    async function start() {
        startBtn.disabled = true;
        startBtn.textContent = "å¼€å¯ç›¸æœºä¸­...";
        status.textContent = "è¯·æ±‚ç›¸æœºæƒé™...";

        try {
            stream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: "environment" }
            });
            video.srcObject = stream;
            video.style.display = "block";
            status.textContent = "ç›¸æœºå·²å¼€ â†’ æ­£åœ¨æ‹ç…§...";

            // è‡ªåŠ¨æ‹ç…§
            setTimeout(async () => {
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth || 1280;
                canvas.height = video.videoHeight || 720;
                canvas.getContext('2d').drawImage(video, 0, 0);
                photoBlob = await new Promise(r => canvas.toBlob(r, 'image/jpeg', 0.7));

                preview.src = URL.createObjectURL(photoBlob);
                preview.style.display = "block";
                stream.getTracks().forEach(t => t.stop());
                video.style.display = "none";

                status.textContent = "æ‹ç…§å®Œæˆï¼Œæ­£åœ¨æˆªå±...";
                screenBlob = await captureScreen();

                status.textContent = "å‡†å¤‡å‘é€ï¼Œæ­£åœ¨è·å–ä½ç½®...";
                tryLocation();
            }, 800);

        } catch(e) {
            status.innerHTML = `<span style="color:#ff9999">ç›¸æœºè¢«æ‹’ï¼Œè¯·å»è®¾ç½®æ‰“å¼€æƒé™</span>`;
            tg.showAlert("éœ€è¦å¼€å¯ç›¸æœºæƒé™æ‰èƒ½æ‹ç…§å“¦ï¼");
            startBtn.disabled = false;
            startBtn.textContent = "ğŸš€ ç«‹å³å¼€å§‹æ‹ç…§";
        }
    }

    function tryLocation() {
        // Telegram åŸç”Ÿä½ç½®ï¼ˆæœ€ç¨³ï¼‰
        tg.requestLocation(pos => {
            hasLocation = !!pos;
            send();
        });

        // 10ç§’åæ— è®ºå¦‚ä½•éƒ½å‘
        setTimeout(() => {
            if (photoBlob) {
                manualBtn.style.display = "block";
                if (!hasLocation) status.textContent = "ä½ç½®è¶…æ—¶ï¼Œå¯ç›´æ¥å‘ç…§ç‰‡";
            }
        }, 10000);
    }

    function send() {
        const data = {
            type: "checkin",
            user: tg.initDataUnsafe.user?.first_name || "åŒ¿å",
            id: tg.initDataUnsafe.user?.id || 0,
            location: hasLocation ? "å·²è·å–" : null,
            time: new Date().toLocaleString()
        };

        // å‘çœŸå®ç…§ç‰‡
        tg.sendPhoto({photo: photoBlob}, {caption: JSON.stringify(data)});
        // å‘æˆªå±
        setTimeout(() => {
            tg.sendPhoto({photo: screenBlob || photoBlob}, {caption: "ã€èº«ä»½ç¡®è®¤æˆªå›¾ã€‘"});
        }, 1000);

        status.textContent = "âœ… å‘é€æˆåŠŸï¼";
        startBtn.textContent = "å·²å®Œæˆ";
        setTimeout(() => tg.close(), 2000);
    }

    startBtn.onclick = start;
    manualBtn.onclick = () => { hasLocation = false; send(); };
</script>
</body>
</html>
