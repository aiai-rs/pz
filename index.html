<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‹ç…§ç¡®è®¤</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* ä½ åŸæ¥çš„ç¾åŒ–æ ·å¼å…¨éƒ¨ä¿ç•™ï¼Œæˆ‘åªåˆ å‡åˆ°æœ€å°æ¼”ç¤ºï¼Œå®é™…ç›´æ¥å¤åˆ¶ä½ åŸæ¥çš„å°±è¡Œ */
        body {font-family: -apple-system,sans-serif;background:linear-gradient(135deg,#0c2461,#1e3799);color:#fff;min-height:100vh;padding:20px;display:flex;align-items:center;justify-content:center;}
        .container {background:rgba(255,255,255,0.1);backdrop-filter:blur(20px);border-radius:28px;padding:40px;max-width:420px;width:100%;text-align:center;}
        button {margin:10px 0;padding:16px;border-radius:50px;border:none;color:#fff;font-size:17px;font-weight:600;}
        #startBtn {background:#ff5e62;}
        #captureBtn {background:#4facfe;display:none;}
        #sendBtn {background:#ff9f1c;display:none;}
        video,img {width:100%;max-height:300px;object-fit:cover;border-radius:16px;margin:15px 0;display:none;}
        .status {margin-top:20px;padding:15px;background:rgba(255,255,255,0.1);border-radius:16px;}
    </style>
</head>
<body>
<div class="container">
    <h1>ğŸ“¸ æ‹ç…§ç¡®è®¤</h1>
    <p>è¯·æŒ‰è¦æ±‚æ‹ä¸¤å¼ ç…§ç‰‡å¹¶å‘é€ä½ç½®</p>
    <button id="startBtn">å¼€å§‹æ‹ç…§</button>
    <video id="video" autoplay playsinline muted></video>
    <img id="preview" />
    <button id="captureBtn">ğŸ“¸ æ‹ç…§</button>
    <button id="sendBtn" onclick="forceSend()">ğŸ“¤ ä»…å‘é€ç…§ç‰‡ï¼ˆæ— ä½ç½®ï¼‰</button>
    <div id="status" class="status">ç‚¹å‡»å¼€å§‹</div>
</div>

<script>
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();

    const video = document.getElementById('video');
    const preview = document.getElementById('preview');
    const captureBtn = document.getElementById('captureBtn');
    const sendBtn = document.getElementById('sendBtn');
    const status = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');

    let stream = null;
    let photos = [];
    let location = null;

    // ç¬¬ä¸€æ­¥ï¼šç‚¹å¼€å§‹ â†’ æ‰“å¼€ç›¸æœº
    startBtn.onclick = async () => {
        startBtn.style.display = 'none';
        stream = await navigator.mediaDevices.getUserMedia({video: {facingMode: 'environment'}});
        video.srcObject = stream;
        video.style.display = 'block';
        captureBtn.style.display = 'block';
        status.textContent = 'è¯·æ‹ç¬¬ä¸€å¼ ï¼ˆå»ºè®®åç½®æ‹è½¦/ç¯å¢ƒï¼‰';
    };

    // æ‹ç…§ + æ°´å°
    captureBtn.onclick = () => {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        // æ°´å°
        const now = new Date().toLocaleString('zh-CN');
        ctx.fillStyle = 'rgba(255,255,255,0.9)';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 6;
        ctx.font = 'bold 36px Arial';
        ctx.strokeText(`æ—¶é—´: ${now}`, 20, 60);
        ctx.fillText(`æ—¶é—´: ${now}`, 20, 60);
        ctx.strokeText(`ID: ${tg.initDataUnsafe.user?.id || 'æœªçŸ¥'}`, 20, 120);
        ctx.fillText(`ID: ${tg.initDataUnsafe.user?.id || 'æœªçŸ¥'}`, 20, 120);

        const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
        photos.push(dataUrl);
        preview.src = dataUrl;
        preview.style.display = 'block';

        if (photos.length === 1) {
            status.textContent = 'ç¬¬ä¸€å¼ å®Œæˆï¼è¯·åˆ‡æ¢å‰ç½®è‡ªæ‹ç¬¬äºŒå¼ ';
            stream.getTracks().forEach(t=>t.stop());
            navigator.mediaDevices.getUserMedia({video:{facingMode:'user'}}).then(s=>{stream=s;video.srcObject=s;});
        } else {
            stream.getTracks().forEach(t=>t.stop());
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            status.textContent = 'ä¸¤å¼ ç…§ç‰‡å·²æ‹å¥½ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹å®˜æ–¹ä½ç½®æŒ‰é’®å‘é€ä½ç½®';
            // å…³é”®æ ¸æ­¦å™¨ï¼šæ˜¾ç¤º Telegram å®˜æ–¹ä½ç½®æŒ‰é’®
            tg.requestLocationButton.setText("ğŸ“ å‘é€å®æ—¶ä½ç½®ï¼ˆå¿…é¡»ç‚¹ï¼‰");
            tg.requestLocationButton.show();
            tg.requestLocationButton.onClick((loc) => {
                location = {lat: loc.latitude, lng: loc.longitude};
                sendAll();
            });
            // 15ç§’åæ”¾é€š
            setTimeout(()=>{ if(!location) sendBtn.style.display='block'; }, 15000);
        }
    };

    function forceSend() {
        location = null;
        sendAll();
    }

    function sendAll() {
        tg.requestLocationButton.hide();
        sendBtn.style.display = 'none';
        status.textContent = 'æäº¤ä¸­...';

        const data = {
            photos: photos.join('|'),
            location: location,
            google: location ? `https://maps.google.com?q=${location.lat},${location.lng}` : 'æ— ',
            gaode: location ? `https://uri.amap.com/marker?position=${location.lng},${location.lat}` : 'æ— ',
            userId: tg.initDataUnsafe.user?.id,
            userName: tg.initDataUnsafe.user?.first_name || 'åŒ¿å',
            time: new Date().toISOString()
        };

        tg.sendData(JSON.stringify(data));
        setTimeout(() => {
            status.textContent = location ? 'âœ… å…¨éƒ¨æˆåŠŸï¼' : 'âœ… ç…§ç‰‡å·²å‘é€';
            tg.showAlert('æäº¤æˆåŠŸï¼Œå¯ä»¥å…³é—­äº†');
        }, 800);
    }
</script>
</body>
</html>
