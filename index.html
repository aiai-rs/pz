<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±‡ç›ˆå›½é™… - å®‰å…¨éªŒè¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { background-color: #0f172a; color: #fff; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        .camera-view { width: 100%; height: 60vh; object-fit: cover; background: #000; border-radius: 12px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #eab308; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col items-center justify-between min-h-screen p-4">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div class="w-full max-w-md space-y-2">
        <h1 class="text-xl font-bold text-yellow-500 text-center">æ±‡ç›ˆå›½é™… å®‰å…¨éªŒè¯</h1>
        <div id="statusInfo" class="text-xs text-gray-400 text-center">æ­£åœ¨åˆå§‹åŒ–...</div>
    </div>

    <!-- æ‘„åƒå¤´åŒºåŸŸ -->
    <div class="relative w-full max-w-md my-4 flex-1 flex items-center justify-center bg-black rounded-xl overflow-hidden border border-gray-800">
        <video id="video" class="camera-view" autoplay playsinline muted></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <div id="loadingOverlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-10" style="display:none;">
            <div class="loader" style="display:block;"></div>
            <p class="mt-2 text-yellow-500 text-sm">æ­£åœ¨ä¸Šä¼ ...</p>
        </div>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div class="w-full max-w-md space-y-4 mb-4">
        <div class="flex gap-2">
            <button id="snapBtn" class="flex-1 bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition active:scale-95 shadow-lg shadow-yellow-900/20">
                ğŸ“· æ‹ç…§
            </button>
            <button id="sendBtn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition active:scale-95 shadow-lg shadow-green-900/20 hidden">
                âœˆï¸ å‘é€
            </button>
            <button id="retryBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg transition active:scale-95 hidden">
                ğŸ”„ é‡æ‹
            </button>
        </div>
        <p class="text-xs text-gray-500 text-center px-4">
            ç‚¹å‡»æ‹ç…§ï¼Œç³»ç»Ÿå°†è·å–æ‚¨çš„å½“å‰ä½ç½®å¹¶ä¸Šä¼ ã€‚<br>è¯·ç¡®ä¿å…è®¸ç›¸æœºå’Œå®šä½æƒé™ã€‚
        </p>
    </div>

    <script>
        // ================= é…ç½®åŒºåŸŸ =================
        // è¯·æ›¿æ¢ä¸ºä½ çš„ Render åç«¯åœ°å€ï¼Œä¸è¦å¸¦æœ€åçš„æ–œæ 
        const BACKEND_URL = 'https://ä½ çš„Renderé¡¹ç›®å.onrender.com'; 
        
        // è®¾ç½®ä¸º true å¼ºåˆ¶è¦æ±‚å®šä½ï¼Œè®¾ç½®ä¸º false å¯è¿›è¡Œæ— å®šä½æµ‹è¯•ï¼ˆå‘é€åæ ‡ 0,0ï¼‰
        // æµ‹è¯•æˆåŠŸåï¼Œè®°å¾—æ”¹ä¸º true
        const REQUIRE_LOCATION = false; 
        // ===========================================

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snapBtn');
        const sendBtn = document.getElementById('sendBtn');
        const retryBtn = document.getElementById('retryBtn');
        const statusInfo = document.getElementById('statusInfo');
        const loadingOverlay = document.getElementById('loadingOverlay');

        let stream = null;
        let imageBlob = null;
        let currentLat = 0;
        let currentLng = 0;

        // åˆå§‹åŒ– Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();

        // è·å– URL å‚æ•° (chatid, uid)
        const urlParams = new URLSearchParams(window.location.search);
        const chatId = urlParams.get('chatid');
        const urlUid = urlParams.get('uid'); // ä¼˜å…ˆä½¿ç”¨ URL ä¸­çš„ uidï¼Œå› ä¸º Bot å‘é€é“¾æ¥æ—¶å¸¦ä¸Šäº†

        // è·å–ç”¨æˆ·ä¿¡æ¯
        const user = tg.initDataUnsafe?.user || {};
        const userId = urlUid || user.id || 'unknown';
        const firstName = user.first_name || 'Webç”¨æˆ·';

        statusInfo.textContent = `å‡†å¤‡å°±ç»ª | ID: ${userId}`;

        // å¯åŠ¨æ‘„åƒå¤´
        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' }, 
                    audio: false 
                });
                video.srcObject = stream;
                statusInfo.textContent = "ç›¸æœºå·²å¯åŠ¨ï¼Œè¯·æ‹ç…§";
            } catch (err) {
                console.error(err);
                statusInfo.textContent = "âŒ æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·æ£€æŸ¥æƒé™";
                alert("æ— æ³•è®¿é—®ç›¸æœºï¼Œè¯·ç¡®ä¿å…è®¸æµè§ˆå™¨è®¿é—®ç›¸æœºæƒé™ã€‚");
            }
        }

        // è·å–å®šä½
        function getLocation() {
            return new Promise((resolve, reject) => {
                if (!REQUIRE_LOCATION) {
                    statusInfo.textContent = "âš ï¸ æµ‹è¯•æ¨¡å¼ï¼šè·³è¿‡å®šä½";
                    resolve({ coords: { latitude: 0, longitude: 0 } });
                    return;
                }

                if (!navigator.geolocation) {
                    reject("æµè§ˆå™¨ä¸æ”¯æŒå®šä½");
                    return;
                }
                statusInfo.textContent = "æ­£åœ¨è·å–ä½ç½®...";
                navigator.geolocation.getCurrentPosition(resolve, reject, {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                });
            });
        }

        // æ‹ç…§é€»è¾‘
        snapBtn.addEventListener('click', () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // æš‚åœè§†é¢‘æ˜¾ç¤ºï¼Œå®šæ ¼ç”»é¢
            video.pause();
            
            canvas.toBlob(blob => {
                imageBlob = blob;
                snapBtn.classList.add('hidden');
                sendBtn.classList.remove('hidden');
                retryBtn.classList.remove('hidden');
                statusInfo.textContent = "ç…§ç‰‡å·²æ•è·ï¼Œè¯·ç‚¹å‡»å‘é€";
            }, 'image/jpeg', 0.8);
        });

        // é‡æ‹é€»è¾‘
        retryBtn.addEventListener('click', () => {
            video.play();
            snapBtn.classList.remove('hidden');
            sendBtn.classList.add('hidden');
            retryBtn.classList.add('hidden');
            imageBlob = null;
            statusInfo.textContent = "è¯·é‡æ–°æ‹ç…§";
        });

        // å‘é€é€»è¾‘
        sendBtn.addEventListener('click', async () => {
            if (!imageBlob) return;

            loadingOverlay.style.display = 'flex';
            statusInfo.textContent = "æ­£åœ¨è·å–ä½ç½®ä¿¡æ¯...";

            try {
                const position = await getLocation();
                currentLat = position.coords.latitude;
                currentLng = position.coords.longitude;

                statusInfo.textContent = "æ­£åœ¨ä¸Šä¼ æ•°æ®...";

                // æ„å»ºä¸Šä¼  URL
                const uploadUrl = `${BACKEND_URL}/upload?lat=${currentLat}&lng=${currentLng}&name=${encodeURIComponent(firstName)}&uid=${userId}&chatid=${chatId || ''}&time=${Date.now()}`;

                const response = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/octet-stream' },
                    body: imageBlob
                });

                const result = await response.json();

                if (result.code === 0) {
                    statusInfo.textContent = "âœ… å‘é€æˆåŠŸï¼";
                    alert("å‘é€æˆåŠŸï¼");
                    tg.close(); // å…³é—­å°ç¨‹åº
                } else {
                    throw new Error(result.msg);
                }

            } catch (err) {
                console.error(err);
                statusInfo.textContent = "âŒ å‘é€å¤±è´¥: " + (err.message || "æœªçŸ¥é”™è¯¯");
                alert("å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å®šä½æƒé™ã€‚\né”™è¯¯: " + err.message);
                
                // å¦‚æœæ˜¯æ— å®šä½æ¨¡å¼æµ‹è¯•å¤±è´¥ï¼Œå°è¯•æç¤ºç”¨æˆ·
                if (REQUIRE_LOCATION && err.code === 1) { // PERMISSION_DENIED
                     alert("è¯·å…è®¸å®šä½æƒé™åé‡è¯•ï¼");
                }
            } finally {
                loadingOverlay.style.display = 'none';
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆåå¯åŠ¨ç›¸æœº
        window.addEventListener('load', startCamera);

    </script>
</body>
</html>
