<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ±‡ç›ˆå›½é™… - å®‰å…¨æ‹ç…§æ‰“å¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<style>
  body { margin:0; font-family: Arial; background:#000; color:#fff; }
  #container { position:relative; width:100vw; height:100vh; }
  video { width:100%; height:100%; object-fit:cover; }
  #overlay {
    position: absolute;
    bottom: 20px;
    left: 20px;
    background: rgba(0,0,0,0.6);
    padding: 12px 18px;
    border-radius: 10px;
    font-size: 18px;
    line-height: 1.5;
    pointer-events: none;
    max-width: 90%;
  }
  #controls { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); }
  button {
    background:#fff; border:none; width:80px; height:80px; border-radius:50%;
    font-size:48px; cursor:pointer; box-shadow:0 6px 30px rgba(0,0,0,0.6);
  }
  #status { position:absolute; top:20px; left:0; right:0; text-align:center; color:#0f0; font-size:16px; padding:0 20px; }
</style>
</head>
<body>
<div id="container">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <div id="overlay">
    <div id="time">è·å–æ—¶é—´ä¸­...</div>
    <div>çº¯åç½®æµ‹è¯•ç‰ˆï¼ˆæ— å®šä½ï¼‰</div>
  </div>
  <div id="controls">
    <button id="capture">ğŸ“¸</button>
  </div>
  <div id="status">ç‚¹å‡»æ‹ç…§æŒ‰é’®å¼€å§‹æ‰“å¡</div>
</div>
<script>
// ==================== é…ç½® ====================
const BACKEND_URL = "https://huiying888.onrender.com/upload";
const urlParams = new URLSearchParams(location.search);
const TARGET_CHAT_ID = urlParams.get('chatid');
// ===============================================

// å®æ—¶æ—¶é—´
function updateTime() {
  const now = new Date();
  document.getElementById('time').textContent = "ğŸ• " + now.toLocaleString('zh-CN', {hour12:false});
}
setInterval(updateTime, 1000);
updateTime();

// å¯åŠ¨åç½®æ‘„åƒå¤´
async function startCamera() {
  const video = document.getElementById('video');
  if (video.srcObject) video.srcObject.getTracks().forEach(t => t.stop());
  const stream = await navigator.mediaDevices.getUserMedia({
    video: { facingMode: "environment", width: {ideal: 4096}, height: {ideal: 4096} },
    audio: false
  });
  video.srcObject = stream;
}

// æ‹ç…§ + æ°´å°
document.getElementById('capture').addEventListener('click', async () => {
  document.getElementById('status').textContent = "ğŸ“¸ æ­£åœ¨æ‹ç…§...";
  await startCamera();
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  canvas.width = video.videoWidth || 1920;
  canvas.height = video.videoHeight || 1080;
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0);

  const now = new Date().toLocaleString('zh-CN', {hour12:false});
  ctx.font = 'bold 44px Arial';
  ctx.fillStyle = 'rgba(255,255,255,0.95)';
  ctx.strokeStyle = 'black';
  ctx.lineWidth = 8;
  ctx.strokeText(now, 40, canvas.height - 80);
  ctx.fillText(now, 40, canvas.height - 80);

  canvas.toBlob(blob => {
    const form = new FormData();
    form.append('photo', blob, 'photo.jpg');
    const url = new URL(BACKEND_URL);
    url.searchParams.set('lat', '0');
    url.searchParams.set('lng', '0');
    url.searchParams.set('name', 'æ±‡ç›ˆç”¨æˆ·');
    url.searchParams.set('time', Date.now());
    if (TARGET_CHAT_ID) url.searchParams.set('chatid', TARGET_CHAT_ID);

    document.getElementById('status').textContent = "â³ æ­£åœ¨ä¸Šä¼ ...";
    fetch(url, { method: 'POST', body: form })
      .then(r => r.json())
      .then(res => {
        document.getElementById('status').innerHTML = res.code === 0 
          ? "âœ… ä¸Šä¼ æˆåŠŸï¼ç…§ç‰‡å·²å‘é€" 
          : "âŒ ä¸Šä¼ å¤±è´¥";
      })
      .catch(() => document.getElementById('status').textContent = "âŒ ç½‘ç»œé”™è¯¯");
  }, 'image/jpeg', 0.95);
});

// é¡µé¢åŠ è½½å¯åŠ¨æ‘„åƒå¤´
navigator.mediaDevices.getUserMedia({video: true}).then(stream => {
  document.getElementById('video').srcObject = stream;
}).catch(() => {});
</script>
</body>
</html>
